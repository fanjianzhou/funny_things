<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸ’©è®° - ä¸ªäººå¥åº·æ’ä¾¿è¿½è¸ª</title>
    <!-- å¼•å…¥å¤–éƒ¨åŠ¨æ•ˆåº“ -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>
    <style>
        :root {
            --bg-color: #f0f4f8;
            --text-main: #334155;
            --text-sub: #64748b;
            --teal: #14b8a6;
            --orange: #f97316;
            --rose: #f43f5e;
            --shadow-light: #ffffff;
            --shadow-dark: #cbd5e0;
            --teal-gradient: linear-gradient(145deg, #16c9b5, #12a695);
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            outline: none;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            line-height: 1.5;
            user-select: none;
        }

        /* æ‹Ÿç‰©åŒ–æ ·å¼åº“ */
        .neu-flat {
            background: var(--bg-color);
            box-shadow: 6px 6px 12px var(--shadow-dark), -6px -6px 12px var(--shadow-light);
        }
        .neu-inset {
            background: var(--bg-color);
            box-shadow: inset 4px 4px 8px var(--shadow-dark), inset -4px -4px 8px var(--shadow-light);
        }
        .neu-button {
            background: var(--bg-color);
            box-shadow: 4px 4px 8px var(--shadow-dark), -4px -4px 8px var(--shadow-light);
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .neu-button:active {
            box-shadow: inset 2px 2px 5px var(--shadow-dark), inset -2px -2px 5px var(--shadow-light);
            transform: scale(0.96);
        }

        /* åŠ¨ç”» */
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes popIn {
            0% { transform: scale(0.8); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        .page-enter { animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        .pop-in { animation: popIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; }

        /* å¸ƒå±€ */
        #app {
            max-width: 600px;
            margin: 0 auto;
            min-height: 100vh;
            padding-bottom: 120px;
        }

        header {
            padding: 40px 20px 20px;
            text-align: center;
        }

        .header-card {
            display: inline-block;
            padding: 15px 30px;
            border-radius: 25px;
            margin-bottom: 15px;
        }

        .header-card h1 {
            margin: 0;
            font-size: 26px;
            letter-spacing: -1px;
        }

        .fact-box {
            font-size: 13px;
            color: var(--text-sub);
            font-style: italic;
            padding: 0 30px;
            margin-top: 10px;
        }

        /* åº•éƒ¨å¯¼èˆª */
        nav.bottom-nav {
            position: fixed;
            bottom: 25px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            background: rgba(240, 244, 248, 0.85);
            backdrop-filter: blur(15px);
            padding: 8px;
            border-radius: 40px;
            gap: 5px;
            z-index: 100;
            border: 1px solid rgba(255,255,255,0.5);
            box-shadow: 0 10px 30px rgba(0,0,0,0.05);
        }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 10px 18px;
            border-radius: 30px;
            color: var(--text-sub);
            font-size: 14px;
            font-weight: bold;
            text-decoration: none;
            transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .nav-item.active {
            background: var(--teal);
            color: white;
            box-shadow: 0 4px 15px rgba(20, 184, 166, 0.4);
        }

        .nav-item .label {
            margin-left: 6px;
            display: none;
        }

        .nav-item.active .label {
            display: inline;
        }

        /* æ‚¬æµ®æŒ‰é’® */
        .fab {
            position: fixed;
            bottom: 105px;
            right: 25px;
            width: 60px;
            height: 60px;
            border-radius: 30px;
            background: var(--teal);
            color: white;
            font-size: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 90;
            box-shadow: 0 8px 20px rgba(20, 184, 166, 0.4);
            border: 2px solid rgba(255,255,255,0.2);
        }

        /* é€šç”¨å®¹å™¨ */
        .content-card {
            margin: 20px;
            padding: 25px;
            border-radius: 35px;
        }

        /* æ—¥å†æ ·å¼ */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 10px;
        }
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }
        .day-cell {
            aspect-ratio: 1;
            border-radius: 16px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            position: relative;
        }
        .day-cell.has-data { border: 1px solid rgba(0,0,0,0.05); }

        /* è¡¨å•æµ®å±‚ */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 200;
            padding: 20px;
            backdrop-filter: blur(8px);
        }
        .modal-content {
            width: 100%;
            max-width: 500px;
            max-height: 85vh;
            overflow-y: auto;
            border-radius: 45px;
            background: var(--bg-color);
            padding: 35px;
            position: relative;
        }

        /* é¢œè‰²é€‰æ‹© */
        .color-dot {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 4px solid white;
            display: inline-block;
            transition: 0.2s;
        }
        .color-dot.active {
            transform: scale(1.3);
            border-color: var(--teal);
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        /* å›¾è¡¨ */
        .chart-container {
            height: 180px;
            width: 100%;
            margin-top: 15px;
            padding: 10px;
        }

        /* éšè—æ»šåŠ¨æ¡ */
        .modal-content::-webkit-scrollbar { display: none; }

        input[type="range"] {
            -webkit-appearance: none;
            width: 100%;
            height: 10px;
            background: #e2e8f0;
            border-radius: 10px;
            outline: none;
            margin: 15px 0;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 24px;
            height: 24px;
            background: var(--teal);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            border: 3px solid white;
        }

        .bristol-select.active {
            background: var(--teal) !important;
            color: white !important;
            box-shadow: inset 2px 2px 5px rgba(0,0,0,0.1);
        }

        .trophy-card {
            padding: 20px;
            border-radius: 25px;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            position: relative;
            transition: 0.3s;
        }
        .trophy-card.locked {
            opacity: 0.4;
            filter: grayscale(1);
        }
        .trophy-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 8px;
            height: 8px;
            background: var(--teal);
            border-radius: 50%;
        }
    </style>
<script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@^19.2.3",
    "react/": "https://esm.sh/react@^19.2.3/",
    "date-fns": "https://esm.sh/date-fns@^4.1.0",
    "date-fns/": "https://esm.sh/date-fns@^4.1.0/",
    "canvas-confetti": "https://esm.sh/canvas-confetti@^1.9.4",
    "recharts": "https://esm.sh/recharts@^3.6.0"
  }
}
</script>
</head>
<body>
    <div id="app"></div>

    <!-- å¼¹çª—æ¨¡æ€æ¡† -->
    <div id="modal" class="modal-overlay">
        <div class="modal-content neu-flat pop-in" id="modal-body"></div>
    </div>

    <script>
        // --- æ ¸å¿ƒå¸¸é‡ ---
        const BRISTOL_MAP = {
            1: { label: 'ç¡¬çƒçŠ¶', emoji: 'ğŸ¥œ', desc: 'åˆ†å¼€çš„ç¡¬å›¢å—ï¼Œåƒåšæœï¼ˆæéš¾æ’å‡ºï¼‰' },
            2: { label: 'é¦™è‚ çŠ¶(ç»“å—)', emoji: 'ğŸ‡', desc: 'é¦™è‚ å½¢çŠ¶ï¼Œä½†æœ‰ç»“å—' },
            3: { label: 'é¦™è‚ çŠ¶(è£‚çº¹)', emoji: 'ğŸŒ½', desc: 'é¦™è‚ å½¢çŠ¶ï¼Œè¡¨é¢æœ‰è£‚çº¹' },
            4: { label: 'é¦™è‚ çŠ¶(å…‰æ»‘)', emoji: 'ğŸŒ', desc: 'åƒé¦™è‚  or è›‡ä¸€æ ·ï¼Œå…‰æ»‘ä¸”æŸ”è½¯' },
            5: { label: 'è½¯å›¢å—', emoji: 'ğŸ¡', desc: 'è¾¹ç¼˜æ¸…æ™°çš„è½¯å›¢å—ï¼ˆå®¹æ˜“æ’å‡ºï¼‰' },
            6: { label: 'ç³ŠçŠ¶', emoji: 'ğŸ¥£', desc: 'è¾¹ç¼˜ä¸æ•´é½ï¼Œç³ŠçŠ¶å †ç§¯' },
            7: { label: 'æ°´çŠ¶', emoji: 'ğŸŒŠ', desc: 'å®Œå…¨æ°´çŠ¶ï¼Œæ²¡æœ‰å›ºä½“å—' },
        };

        const COLOR_MAP = {
            brown: { label: 'è¤è‰²', hex: '#8B4513' },
            yellow: { label: 'é»„è‰²', hex: '#DAA520' },
            green: { label: 'ç»¿è‰²', hex: '#556B2F' },
            black: { label: 'é»‘è‰²', hex: '#2F4F4F' },
            red: { label: 'çº¢è‰²', hex: '#B22222' },
            pale: { label: 'æµ…è‰²', hex: '#DEB887' },
        };

        const POOP_FACTS = [
            "è‚ é“è¢«èª‰ä¸ºâ€˜ç¬¬äºŒå¤§è„‘â€™ï¼Œå«æœ‰æ•°äº¿ä¸ªç¥ç»å…ƒã€‚",
            "å¤šå–æ°´æ˜¯ç¼“è§£ä¾¿ç§˜æœ€æœ‰æ•ˆçš„æ–¹æ³•ã€‚",
            "æ­£å¸¸çš„æ’ä¾¿é¢œè‰²é€šå¸¸åœ¨è¤è‰²èŒƒå›´å†…ã€‚",
            "è¹²ç€æ’ä¾¿æ¯”åç€æ›´é¡ºç•…ã€‚",
            "é¦™è•‰å½¢çŠ¶çš„4å‹å¤§ä¾¿æ˜¯å…¬è®¤çš„â€˜é‡‘ç‰Œé€‰æ‰‹â€™ã€‚",
            "è†³é£Ÿçº¤ç»´æ˜¯ç›Šç”ŸèŒçš„â€˜åŠ æ²¹ç«™â€™ã€‚",
            "æ¯å¤©è§„å¾‹æ—¶é—´æ’ä¾¿ï¼Œå¯ä»¥è®­ç»ƒè‚ é“ç”Ÿç‰©é’Ÿã€‚",
        ];

        // --- çŠ¶æ€ç®¡ç† ---
        let state = {
            user: JSON.parse(localStorage.getItem('poop_log_user') || '{"name":""}'),
            logs: JSON.parse(localStorage.getItem('poop_log_data') || '{}'),
            activeTab: 'calendar',
            currentCalendarMonth: new Date(),
            selectedDate: new Date().toISOString().split('T')[0],
            randomFact: POOP_FACTS[Math.floor(Math.random() * POOP_FACTS.length)]
        };

        function saveToStorage() {
            localStorage.setItem('poop_log_user', JSON.stringify(state.user));
            localStorage.setItem('poop_log_data', JSON.stringify(state.logs));
        }

        // --- å·¥å…·å‡½æ•° ---
        const formatDate = (date) => {
            const d = new Date(date);
            return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
        };

        // --- æ ¸å¿ƒæ¸²æŸ“å¼•æ“ ---
        function render() {
            const app = document.getElementById('app');
            app.innerHTML = `
                <header class="page-enter">
                    <div class="header-card neu-flat">
                        <h1>${state.user.name ? state.user.name + 'çš„' : ''}ğŸ’©è®°</h1>
                    </div>
                    <div class="fact-box">â€œ${state.randomFact}â€</div>
                </header>

                <main id="main-content" class="page-enter">
                    ${renderTabContent()}
                </main>

                ${state.activeTab === 'calendar' ? `<button class="fab" onclick="openLogForm('${formatDate(new Date())}')">ğŸ’©</button>` : ''}

                <nav class="bottom-nav">
                    <a href="javascript:void(0)" class="nav-item ${state.activeTab === 'calendar' ? 'active' : ''}" onclick="switchTab('calendar')">ğŸ“… <span class="label">æ—¥å†</span></a>
                    <a href="javascript:void(0)" class="nav-item ${state.activeTab === 'stats' ? 'active' : ''}" onclick="switchTab('stats')">ğŸ“ˆ <span class="label">è¶‹åŠ¿</span></a>
                    <a href="javascript:void(0)" class="nav-item ${state.activeTab === 'trophy' ? 'active' : ''}" onclick="switchTab('trophy')">ğŸ† <span class="label">æˆå°±</span></a>
                    <a href="javascript:void(0)" class="nav-item ${state.activeTab === 'settings' ? 'active' : ''}" onclick="switchTab('settings')">âš™ï¸ <span class="label">è®¾ç½®</span></a>
                </nav>
            `;
        }

        function switchTab(tab) {
            state.activeTab = tab;
            render();
        }

        function renderTabContent() {
            switch (state.activeTab) {
                case 'calendar': return renderCalendar();
                case 'stats': return renderStats();
                case 'trophy': return renderTrophies();
                case 'settings': return renderSettings();
                default: return '';
            }
        }

        // --- è§†å›¾ç»„ä»¶ ---

        function renderCalendar() {
            const date = state.currentCalendarMonth;
            const year = date.getFullYear();
            const month = date.getMonth();
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const todayStr = formatDate(new Date());

            let html = `
                <div class="content-card neu-flat">
                    <div class="calendar-header">
                        <button class="neu-button" style="width:36px; height:36px; border-radius:50%;" onclick="changeMonth(-1)">â†</button>
                        <span style="font-weight:800; font-size:18px;">${year}å¹´ ${month + 1}æœˆ</span>
                        <button class="neu-button" style="width:36px; height:36px; border-radius:50%;" onclick="changeMonth(1)">â†’</button>
                    </div>
                    <div class="calendar-grid">
                        ${['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'].map(d => `<div style="text-align:center; font-size:10px; color:var(--text-sub); font-weight:800; padding-bottom:10px;">${d}</div>`).join('')}
                        ${Array(firstDay).fill(0).map(() => `<div></div>`).join('')}
                        ${Array.from({ length: daysInMonth }).map((_, i) => {
                            const d = i + 1;
                            const dateKey = `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                            const dayLogs = state.logs[dateKey] || [];
                            const isToday = dateKey === todayStr;
                            
                            let style = isToday ? 'outline: 2px solid var(--teal); outline-offset: 2px;' : '';
                            if (dayLogs.length > 0) {
                                const isHealthy = dayLogs.every(l => l.type >= 3 && l.type <= 5);
                                style += isHealthy ? 'background: #dcfce7; border: 1px solid #86efac;' : 'background: #fee2e2; border: 1px solid #fca5a5;';
                            }

                            return `
                                <div class="day-cell neu-button" style="${style}" onclick="openLogForm('${dateKey}')">
                                    <span style="position:absolute; top:4px; left:6px; font-size:9px; font-weight:bold; opacity:0.5;">${d}</span>
                                    <span style="font-size:16px;">${dayLogs[0] ? BRISTOL_MAP[dayLogs[0].type].emoji : ''}</span>
                                    ${dayLogs.length > 1 ? `<span style="font-size:8px; font-weight:bold; position:absolute; bottom:2px; right:4px;">+${dayLogs.length - 1}</span>` : ''}
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
            return html;
        }

        window.changeMonth = (delta) => {
            state.currentCalendarMonth.setMonth(state.currentCalendarMonth.getMonth() + delta);
            render();
        };

        function renderStats() {
            const allLogs = Object.entries(state.logs).flatMap(([date, list]) => list);
            if (allLogs.length === 0) return `<div class="content-card neu-flat" style="text-align:center; color:var(--text-sub);">è¿˜æ²¡æœ‰è®°å½•å‘¢ï¼Œå¿«å»ç‚¹å‡» ğŸ’© æŒ‰é’®å§ï¼</div>`;

            // SVG è¶‹åŠ¿å›¾ (æœ€è¿‘7æ¡)
            const recent = allLogs.slice(-7);
            const points = recent.map((l, i) => {
                const x = (i / 6) * 100;
                const y = 100 - (l.type / 7) * 100;
                return `${x},${y}`;
            }).join(' ');

            return `
                <div class="content-card neu-flat">
                    <h3 style="margin:0 0 10px;">ğŸ“‰ å¸ƒé‡Œæ–¯æ‰˜è¶‹åŠ¿</h3>
                    <p style="font-size:11px; color:var(--text-sub); margin-bottom:15px;">åæ˜ æœ€è¿‘ 7 æ¬¡è®°å½•çš„æ€§çŠ¶æ³¢åŠ¨</p>
                    <div class="chart-container">
                        <svg viewBox="0 0 100 100" preserveAspectRatio="none" style="width:100%; height:100%; overflow:visible;">
                            <polyline points="${points}" fill="none" stroke="var(--teal)" stroke-width="2.5" vector-effect="non-scaling-stroke" stroke-linejoin="round" stroke-linecap="round" />
                            ${recent.map((l, i) => `
                                <circle cx="${(i / 6) * 100}" cy="${100 - (l.type / 7) * 100}" r="3" fill="white" stroke="var(--teal)" stroke-width="1.5" />
                            `).join('')}
                        </svg>
                    </div>
                </div>

                <div class="content-card neu-flat" style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; text-align:center;">
                    <div class="neu-inset" style="padding:20px; border-radius:25px;">
                        <div style="font-size:11px; font-weight:bold; color:var(--text-sub);">ç´¯è®¡è®°å½•</div>
                        <div style="font-size:28px; font-weight:900; color:var(--teal);">${allLogs.length}</div>
                    </div>
                    <div class="neu-inset" style="padding:20px; border-radius:25px;">
                        <div style="font-size:11px; font-weight:bold; color:var(--text-sub);">å¥åº·å æ¯”</div>
                        <div style="font-size:28px; font-weight:900; color:var(--orange);">
                            ${Math.round((allLogs.filter(l => l.type >= 3 && l.type <= 5).length / allLogs.length) * 100)}%
                        </div>
                    </div>
                </div>
            `;
        }

        function renderTrophies() {
            const allLogs = Object.values(state.logs).flat();
            const total = allLogs.length;
            const healthCount = allLogs.filter(l => l.type >= 3 && l.type <= 5).length;
            const colors = new Set(allLogs.map(l => l.color)).size;

            const trophies = [
                { id: 1, title: 'åˆæ¬¡é‚‚é€…', icon: 'ğŸ‘¶', desc: 'æˆåŠŸè®°å½• 1 æ¬¡', active: total >= 1 },
                { id: 2, title: 'åå…¨åç¾', icon: 'ğŸ…', desc: 'ç´¯è®¡è®°å½• 10 æ¬¡', active: total >= 10 },
                { id: 3, title: 'é»„é‡‘ä¹‹è·¯', icon: 'ğŸŒŸ', desc: 'è®°å½• 5 æ¬¡å¥åº·ä¾¿ä¾¿', active: healthCount >= 5 },
                { id: 4, title: 'è‰²å½©ä¸“å®¶', icon: 'ğŸ¨', desc: 'è§è¿‡ 3 ç§é¢œè‰²', active: colors >= 3 },
                { id: 5, title: 'åšæŒä¸æ‡ˆ', icon: 'ğŸ†', desc: 'è®°å½• 30 æ¬¡', active: total >= 30 },
                { id: 6, title: 'å¥åº·è¾¾äºº', icon: 'ğŸ¥—', desc: 'è®°å½• 50 æ¬¡', active: total >= 50 },
            ];

            return `
                <div class="content-card neu-flat" style="text-align:center; padding-bottom: 10px;">
                    <h2 style="margin:0 0 5px;">ğŸ† è£èª‰å‹‹ç« </h2>
                    <p style="font-size:12px; color:var(--text-sub); margin-bottom:20px;">è®°å½•ç‚¹æ»´è¿›æ­¥ï¼Œå®ˆæŠ¤è‚ é“å¥åº·</p>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                        ${trophies.map(t => `
                            <div class="trophy-card neu-button ${t.active ? '' : 'locked'}">
                                ${t.active ? '<div class="trophy-badge"></div>' : ''}
                                <div style="font-size:32px; margin-bottom:8px;">${t.icon}</div>
                                <div style="font-size:13px; font-weight:900;">${t.title}</div>
                                <div style="font-size:10px; color:var(--text-sub); margin-top:4px;">${t.desc}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function renderSettings() {
            return `
                <div class="content-card neu-flat">
                    <h3 style="margin-top:0;">ğŸ‘¤ ä¸ªäººèµ„æ–™</h3>
                    <div style="margin-bottom:20px;">
                        <label style="font-size:11px; font-weight:bold; color:var(--text-sub); margin-left:10px;">ä½ çš„ç§°å‘¼</label>
                        <input type="text" id="username-input" class="neu-inset" value="${state.user.name}" style="width:100%; border:none; padding:15px; border-radius:20px; margin-top:8px; font-size:14px; font-weight:bold;" placeholder="å–ä¸ªå¥½å¬çš„åå­—å§">
                    </div>
                    <button class="neu-button" onclick="saveSettings()" style="width:100%; padding:15px; border-radius:20px; background:var(--teal); color:white; font-weight:900; font-size:15px;">ä¿å­˜ä¿®æ”¹</button>
                </div>

                <div class="content-card neu-flat">
                    <h3>ğŸ’¾ æ•°æ®ç®¡ç†</h3>
                    <p style="font-size:11px; color:var(--text-sub); margin-bottom:15px;">æ•°æ®å­˜å‚¨åœ¨æœ¬åœ°æµè§ˆå™¨ï¼Œå»ºè®®å®šæœŸå¯¼å‡ºå¤‡ä»½ã€‚</p>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                        <button class="neu-button" onclick="exportJSON()" style="padding:15px; border-radius:18px; font-weight:bold;">ğŸ“¤ å¯¼å‡º</button>
                        <button class="neu-button" onclick="confirmReset()" style="padding:15px; border-radius:18px; font-weight:bold; color:var(--rose);">ğŸ—‘ï¸ æ¸…ç©º</button>
                    </div>
                </div>
            `;
        }

        // --- ä¸šåŠ¡é€»è¾‘ ---

        window.saveSettings = () => {
            const name = document.getElementById('username-input').value;
            state.user.name = name;
            saveToStorage();
            alert('ä¿å­˜æˆåŠŸï¼');
            render();
        };

        window.exportJSON = () => {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(state.logs));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "poop_tracker_backup.json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        };

        window.confirmReset = () => {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) {
                state.logs = {};
                saveToStorage();
                render();
            }
        };

        window.openLogForm = (dateKey) => {
            state.selectedDate = dateKey;
            const modal = document.getElementById('modal');
            const body = document.getElementById('modal-body');
            modal.style.display = 'flex';

            let currentBristol = 4;
            let currentColor = 'brown';

            const updateFormUI = () => {
                body.innerHTML = `
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:25px;">
                        <h3 style="margin:0;">âœ¨ æŠ•é€’ ğŸ’© è®°</h3>
                        <button class="neu-button" onclick="closeModal()" style="width:32px; height:32px; border-radius:50%; font-size:12px;">âœ•</button>
                    </div>
                    
                    <div style="font-size:11px; font-weight:800; color:var(--teal); background:rgba(20,184,166,0.1); padding:8px 15px; border-radius:12px; display:inline-block; margin-bottom:20px;">
                        æ—¥æœŸï¼š${dateKey}
                    </div>

                    <div style="margin-bottom:25px;">
                        <div style="margin-bottom:12px; font-size:14px; font-weight:900;">1. æ’ä¾¿æ€§çŠ¶ (Bristol)</div>
                        <div style="display:grid; grid-template-columns: repeat(7, 1fr); gap:6px;">
                            ${Object.keys(BRISTOL_MAP).map(type => `
                                <button class="neu-button bristol-btn ${type == currentBristol ? 'active' : ''}" onclick="selectBristol(${type})" style="padding:10px 0; border-radius:12px; flex-direction:column; display:flex; align-items:center;">
                                    <span style="font-size:20px;">${BRISTOL_MAP[type].emoji}</span>
                                    <span style="font-size:8px; margin-top:4px;">${type}å‹</span>
                                </button>
                            `).join('')}
                        </div>
                        <div style="margin-top:12px; padding:12px; background:white; border-radius:15px; font-size:11px; color:var(--text-sub); font-style:italic;">
                            ${BRISTOL_MAP[currentBristol].desc}
                        </div>
                    </div>

                    <div style="margin-bottom:25px;">
                        <div style="margin-bottom:12px; font-size:14px; font-weight:900;">2. é¢œè‰²é€‰æ‹©</div>
                        <div style="display:flex; justify-content:space-between; padding: 0 10px;">
                            ${Object.keys(COLOR_MAP).map(c => `
                                <button class="color-dot ${c === currentColor ? 'active' : ''}" onclick="selectColor('${c}')" style="background-color:${COLOR_MAP[c].hex};"></button>
                            `).join('')}
                        </div>
                    </div>

                    <div style="margin-bottom:30px;">
                        <div style="margin-bottom:12px; font-size:14px; font-weight:900;">3. å¿ƒæƒ…ç¬”è®°</div>
                        <textarea id="log-note" class="neu-inset" style="width:100%; border:none; padding:15px; border-radius:20px; min-height:80px; font-size:13px; outline:none;" placeholder="æ­¤æ—¶æ­¤åˆ»çš„æ„Ÿè§‰..."></textarea>
                    </div>

                    <button class="neu-button" onclick="saveEntry(${currentBristol}, '${currentColor}')" style="width:100%; padding:18px; border-radius:25px; background:var(--teal); color:white; font-size:18px; font-weight:900; box-shadow: 0 8px 20px rgba(20,184,166,0.3);">æäº¤ ğŸ’©</button>
                `;
            };

            window.selectBristol = (type) => { currentBristol = type; updateFormUI(); };
            window.selectColor = (c) => { currentColor = c; updateFormUI(); };
            
            window.saveEntry = (type, color) => {
                const note = document.getElementById('log-note').value;
                const entry = { type, color, note, id: Date.now() };
                
                if (!state.logs[dateKey]) state.logs[dateKey] = [];
                state.logs[dateKey].push(entry);
                
                saveToStorage();
                closeModal();
                render();

                if (type >= 3 && type <= 5) {
                    confetti({ particleCount: 150, spread: 80, origin: { y: 0.7 } });
                }
            };

            updateFormUI();
        };

        window.closeModal = () => {
            document.getElementById('modal').style.display = 'none';
        };

        // å¯åŠ¨åº”ç”¨
        render();

        // ç›‘å¬ç‚¹å‡»èƒŒæ™¯å…³é—­å¼¹çª—
        document.getElementById('modal').onclick = (e) => {
            if (e.target.id === 'modal') closeModal();
        };
    </script>
</body>
</html>
