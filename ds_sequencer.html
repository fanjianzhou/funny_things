<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FC Pixel Drum Sequencer</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap">
    <style>
        /* åŸºç¡€æ ·å¼ - ä¿æŒä¸å˜ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            image-rendering: pixelated;
            image-rendering: crisp-edges;
            user-select: none; /* é»˜è®¤æ‰€æœ‰æ–‡å­—ä¸å¯é€‰æ‹© */
        }
        
        body {
            font-family: 'Press Start 2P', cursive, monospace;
            background-color: #3a3a3a;
            color: #fff;
            line-height: 1.6;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            overflow-y: auto; /* å…è®¸ç”¨æˆ·æ»šåŠ¨ */
        }
        
        .container {
            max-width: 1100px;
            width: 100%;
            background-color: #4a4a4a;
            border: 8px solid #2a2a2a;
            border-radius: 4px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }
        
        /* å…¨å±æŒ‰é’®æ ·å¼ - ä¿æŒä¸å˜ */
        .fullscreen-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            font-family: 'Press Start 2P', cursive;
            background-color: #4a4a4a;
            color: #fff;
            border: none;
            padding: 10px 15px;
            border-radius: 2px;
            cursor: pointer;
            font-size: 12px;
            border: 3px solid #2a2a2a;
            transition: all 0.1s;
            z-index: 1000;
        }
        
        .fullscreen-btn:hover {
            background-color: #5a5a5a;
            transform: translateY(-2px);
        }
        
        .fullscreen-btn:active {
            transform: translateY(1px);
        }
        
        .header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 4px solid #2a2a2a;
        }
        
        h1 {
            color: #f8d038;
            text-shadow: 3px 3px 0 #a82a2a;
            font-size: 28px;
            margin-bottom: 10px;
            letter-spacing: 1px;
        }
        
        .subtitle {
            color: #a8e0f0;
            font-size: 14px;
        }
        
        /* æ§åˆ¶é¢æ¿æ ·å¼ - ä¿æŒä¸å˜ */
        .control-panel {
            background-color: #2a2a2a;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            border: 4px solid #1a1a1a;
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            gap: 15px;
        }
        
        .bpm-control {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap; /* å…è®¸æ¢è¡Œ */
        }
        
        .bpm-label {
            color: #f8d038;
            font-size: 14px;
        }
        
        .bpm-value {
            color: #a8e0f0;
            font-size: 18px;
            min-width: 50px;
            text-align: center;
        }
        
        /* è‡ªå®šä¹‰æ»šåŠ¨æ¡æ ·å¼ - ä¿æŒä¸å˜ */
        ::-webkit-scrollbar {
            width: 12px;
            height: 12px;
        }
        
        ::-webkit-scrollbar-track {
            background: #4a4a4a;
            border: 2px solid #1a1a1a;
            border-radius: 2px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #f8d038;
            border: 2px solid #a82a2a;
            border-radius: 2px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #ffea8c;
        }
        
        /* BPMæ»‘å—æ ·å¼ - ä¿æŒä¸å˜ */
        .bpm-slider {
            -webkit-appearance: none;
            width: 180px;
            height: 12px;
            background: #4a4a4a;
            border-radius: 2px;
            border: 2px solid #1a1a1a;
        }
        
        .bpm-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 24px;
            height: 24px;
            background: #f8d038;
            border-radius: 2px;
            border: 2px solid #a82a2a;
            cursor: pointer;
        }
        
        .time-signature {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap; /* å…è®¸æ¢è¡Œ */
        }
        
        .time-signature-label {
            color: #f8d038;
            font-size: 14px;
        }
        
        .time-signature-buttons {
            display: flex;
            gap: 5px;
        }
        
        .transport-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap; /* å…è®¸æ¢è¡Œ */
        }
        
        /* æŒ‰é’®æ ·å¼ - ä¿æŒä¸å˜ */
        .btn {
            font-family: 'Press Start 2P', cursive;
            background-color: #4a4a4a;
            color: #fff;
            border: none;
            padding: 10px 15px;
            border-radius: 2px;
            cursor: pointer;
            font-size: 12px;
            border: 3px solid #2a2a2a;
            transition: all 0.1s;
        }
        
        .btn:hover {
            background-color: #5a5a5a;
            transform: translateY(-2px);
        }
        
        .btn:active {
            transform: translateY(1px);
        }
        
        .btn-play {
            background-color: #3a9e3a;
            color: #fff;
        }
        
        .btn-stop {
            background-color: #a82a2a;
            color: #fff;
        }
        
        .btn-loop {
            background-color: #8a6df0;
            color: #fff;
        }
        
        .btn-new {
            background-color: #55aaff;
            color: #fff;
        }
        
        .btn-caption {
            background-color: #e080c0;
            color: #fff;
        }
        
        .btn-help {
            background-color: #f8d038;
            color: #2a2a2a;
        }
        
        .btn.active {
            background-color: #f8d038;
            color: #2a2a2a;
        }
        
        /* Blockæ§åˆ¶æ ·å¼ - ä¿æŒä¸å˜ */
        .block-controls {
            background-color: #2a2a2a;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            border: 4px solid #1a1a1a;
        }
        
        .block-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .block-title {
            color: #f8d038;
            font-size: 14px;
        }
        
        .block-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .blocks-list {
            display: flex;
            gap: 10px;
            padding: 10px;
            background-color: #1a1a1a;
            border-radius: 2px;
            overflow-x: auto;
        }
        
        .block-item {
            min-width: 80px;
            padding: 10px;
            background-color: #4a4a4a;
            border: 2px solid #3a3a3a;
            border-radius: 2px;
            text-align: center;
            cursor: pointer;
            transition: all 0.1s;
            font-size: 12px;
            flex-shrink: 0;
        }
        
        .block-item:hover {
            background-color: #5a5a5a;
        }
        
        .block-item.active {
            background-color: #f8d038;
            color: #2a2a2a;
            border-color: #a82a2a;
        }
        
        /* éŸ³åºå™¨ç½‘æ ¼æ ·å¼ - ä¿æŒä¸å˜ */
        .sequencer-grid {
            background-color: #2a2a2a;
            padding: 20px;
            border-radius: 4px;
            border: 4px solid #1a1a1a;
            margin-bottom: 20px;
        }
        
        .drum-row {
            display: flex;
            margin-bottom: 8px;
            align-items: center;
        }
        
        .drum-label {
            color: #f8d038;
            font-size: 12px;
            width: 140px;
            text-align: right;
            padding-right: 20px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .drum-label.muted {
            color: #ff5555;
            text-decoration: line-through;
        }
        
        .step-cells {
            display: flex;
            flex-grow: 1;
        }
        
        .step-cell {
            width: 45px;
            height: 45px;
            background-color: #4a4a4a;
            border: 2px solid #3a3a3a;
            margin-right: 4px;
            cursor: pointer;
            transition: all 0.1s;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 10px;
        }
        
        .step-cell:hover {
            background-color: #5a5a5a;
        }
        
        .step-cell.active {
            border-color: #a82a2a;
        }
        
        .step-cell.active.kick {
            background-color: #f8d038;
        }
        
        .step-cell.active.snare {
            background-color: #a8e0f0;
        }
        
        .step-cell.active.hihat {
            background-color: #3a9e3a;
        }
        
        .step-cell.active.openhat {
            background-color: #a82a2a;
        }
        
        .step-cell.active.clap {
            background-color: #e080c0;
        }
        
        .step-cell.active.triangle {
            background-color: #8a6df0;
        }
        
        .step-cell.active.square_a {
            background-color: #ffaa55;
        }
        
        .step-cell.active.square_b {
            background-color: #ffcc88;
        }
        
        .step-cell.active.sawtooth {
            background-color: #55aaff;
        }
        
        .step-cell.active.caption {
            background-color: #ffffff;
        }
        
        .step-cell.current {
            box-shadow: 0 0 10px #fff;
            position: relative;
            z-index: 1;
        }
        
        .step-cell .note-value {
            position: absolute;
            bottom: 2px;
            right: 2px;
            font-size: 8px;
            color: #000;
            background-color: rgba(255, 255, 255, 0.7);
            padding: 1px 3px;
            border-radius: 1px;
            pointer-events: none;
        }
        
        .step-cell .caption-text {
            position: absolute;
            top: 2px;
            left: 2px;
            font-size: 8px;
            color: #000;
            pointer-events: none;
            max-width: 40px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        /* å¯è§†åŒ–åŒºåŸŸæ ·å¼ - ä¿æŒä¸å˜ */
        .visualizer {
            height: 100px;
            background-color: #1a1a1a;
            border-radius: 4px;
            margin-bottom: 20px;
            border: 4px solid #2a2a2a;
            position: relative;
            overflow: hidden;
        }
        
        .beat-indicator {
            position: absolute;
            top: 0;
            left: 0;
            width: 5px;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.7);
            transition: left 0.1s linear;
        }
        
        .waveform {
            position: absolute;
            top: 50%;
            left: 0;
            width: 100%;
            height: 40px;
            transform: translateY(-50%);
        }
        
        .waveform-bar {
            position: absolute;
            bottom: 0;
            width: 4px;
            background-color: #a8e0f0;
            transition: height 0.05s;
        }
        
        /* è¶£å‘³å¯è§†åŒ–åŒºåŸŸæ ·å¼ - ä¿æŒä¸å˜ */
        .fun-visualizer {
            height: 80px;
            background-color: #1a1a1a;
            border-radius: 4px;
            margin-bottom: 20px;
            border: 4px solid #2a2a2a;
            position: relative;
            overflow: hidden;
        }
        
        .emoji-char {
            position: absolute;
            font-size: 24px;
            bottom: 0;
            transition: bottom 0.2s ease-out;
            filter: drop-shadow(2px 2px 0 #000);
        }
        
        /* å­—å¹•æ˜¾ç¤ºåŒºåŸŸ - ä¿æŒä¸å˜ */
        .caption-display {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-family: Arial, sans-serif;
            font-size: 24px;
            color: #f8d038;
            text-shadow: 3px 3px 0 #a82a2a;
            z-index: 10;
            max-width: 90%;
            text-align: center;
            padding: 10px;
            display: none;
        }
        
        .caption-display.preview {
            color: #a8e0f0;
            text-shadow: 2px 2px 0 #000;
        }
        
        .caption-display.show {
            display: block;
        }
        
        /* é«˜çº§è®¾ç½®æ ·å¼ - ä¿æŒä¸å˜ */
        .advance-settings {
            background-color: #2a2a2a;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            border: 4px solid #1a1a1a;
            display: none;
        }
        
        .advance-settings.active {
            display: block;
        }
        
        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .settings-title {
            color: #f8d038;
            font-size: 14px;
        }
        
        .settings-content {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
        }
        
        .setting-group {
            background-color: #1a1a1a;
            padding: 10px;
            border-radius: 2px;
        }
        
        .setting-group h3 {
            color: #a8e0f0;
            font-size: 12px;
            margin-bottom: 10px;
            border-bottom: 1px solid #3a3a3a;
            padding-bottom: 5px;
        }
        
        .setting-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-size: 10px;
        }
        
        .setting-label {
            color: #ccc;
            width: 120px;
        }
        
        .setting-value {
            color: #f8d038;
            min-width: 40px;
            text-align: right;
        }
        
        /* é«˜çº§è®¾ç½®æ»‘å—æ ·å¼ - ä¿æŒä¸å˜ */
        .setting-slider {
            -webkit-appearance: none;
            width: 120px;
            height: 12px;
            background: #4a4a4a;
            border-radius: 2px;
            border: 2px solid #1a1a1a;
        }
        
        .setting-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 2px;
            border: 2px solid #a82a2a;
            cursor: pointer;
        }
        
        /* ä¸ºä¸åŒè®¾ç½®é¡¹æ·»åŠ é¢œè‰² - ä¿æŒä¸å˜ */
        .setting-slider.attack::-webkit-slider-thumb {
            background: #f8d038;
        }
        
        .setting-slider.decay::-webkit-slider-thumb {
            background: #a8e0f0;
        }
        
        .setting-slider.tone::-webkit-slider-thumb {
            background: #3a9e3a;
        }
        
        .setting-slider.noise::-webkit-slider-thumb {
            background: #a82a2a;
        }
        
        .setting-slider.volume::-webkit-slider-thumb {
            background: #e080c0;
        }
        
        .setting-slider.delay::-webkit-slider-thumb {
            background: #8a6df0;
        }
        
        .setting-slider.count::-webkit-slider-thumb {
            background: #ffaa55;
        }
        
        .setting-slider.duty::-webkit-slider-thumb {
            background: #55aaff;
        }
        
        .setting-slider.vibrato-speed::-webkit-slider-thumb {
            background: #ff55aa;
        }
        
        .setting-slider.vibrato-depth::-webkit-slider-thumb {
            background: #55ffaa;
        }
        
        .setting-slider.vibrato-attack::-webkit-slider-thumb {
            background: #ffaa55;
        }
        
        .setting-slider.bitcrush::-webkit-slider-thumb {
            background: #8a6df0; /* ä¸‰è§’æ³¢é¢œè‰² */
        }
        
        /* é’¢ç´é”®ç›˜æ ·å¼ - ä¿æŒä¸å˜ */
        .piano-container {
            background-color: #2a2a2a;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            border: 4px solid #1a1a1a;
        }
        
        .piano-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .piano-title {
            color: #f8d038;
            font-size: 14px;
        }
        
        .piano-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .piano-keyboard {
            display: flex;
            height: 80px;
            position: relative;
            background-color: #1a1a1a;
            border-radius: 2px;
            padding: 5px;
        }
        
        .piano-key {
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.1s;
            font-size: 10px;
            color: #000;
            flex: 1;
            height: 100%;
            margin-right: 2px;
            border-radius: 2px;
        }
        
        .piano-key:last-child {
            margin-right: 0;
        }
        
        .white-key {
            background-color: #fff;
            border: 2px solid #ccc;
        }
        
        .white-key:hover {
            background-color: #f0f0f0;
        }
        
        .white-key.active {
            background-color: #f8d038;
            border-color: #a82a2a;
        }
        
        .black-key {
            background-color: #333;
            border: 2px solid #222;
        }
        
        .black-key:hover {
            background-color: #555;
        }
        
        .black-key.active {
            background-color: #8a6df0;
            border-color: #a82a2a;
        }
        
        .key-label {
            pointer-events: none;
            text-align: center;
            line-height: 1.2;
        }
        
        /* æ­Œæ›²å¯¼å‡ºåŒºåŸŸæ ·å¼ - ä¿æŒä¸å˜ */
        .song-export {
            background-color: #2a2a2a;
            padding: 15px;
            border-radius: 4px;
            border: 4px solid #1a1a1a;
        }
        
        .song-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .song-title {
            color: #f8d038;
            font-size: 14px;
        }
        
        .song-buttons {
            display: flex;
            gap: 10px;
        }
        
        .file-input {
            display: none;
        }
        
        .file-label {
            font-family: 'Press Start 2P', cursive;
            background-color: #4a4a4a;
            color: #fff;
            border: none;
            padding: 10px 15px;
            border-radius: 2px;
            cursor: pointer;
            font-size: 12px;
            border: 3px solid #2a2a2a;
            transition: all 0.1s;
            display: inline-block;
        }
        
        .file-label:hover {
            background-color: #5a5a5a;
            transform: translateY(-2px);
        }
        
        .file-label:active {
            transform: translateY(1px);
        }
        
        /* å…¨å±æ¨¡å¼ä¸‹çš„æ ·å¼è°ƒæ•´ - ä¿æŒä¸å˜ */
        body:fullscreen {
            padding: 0;
            background-color: #3a3a3a;
        }
        
        body:fullscreen .container {
            max-width: 100%;
            height: 100vh;
            border: none;
            border-radius: 0;
            padding: 20px;
            overflow-y: auto;
        }
        
        body:fullscreen .fullscreen-btn {
            top: 10px;
            right: 10px;
        }
        
        /* å­—å¹•éŸ³åºå™¨åŒºåŸŸ - ä¿æŒä¸å˜ */
        .caption-sequencer {
            background-color: #2a2a2a;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            border: 4px solid #1a1a1a;
            display: none;
        }
        
        .caption-sequencer.active {
            display: block;
        }
        
        .caption-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .caption-title {
            color: #f8d038;
            font-size: 14px;
        }
        
        .caption-row {
            display: flex;
            margin-bottom: 8px;
            align-items: center;
        }
        
        .caption-label {
            color: #f8d038;
            font-size: 12px;
            width: 140px;
            text-align: right;
            padding-right: 20px;
        }
        
        .caption-step-cells {
            display: flex;
            flex-grow: 1;
        }
        
        .caption-step-cell {
            width: 45px;
            height: 45px;
            background-color: #4a4a4a;
            border: 2px solid #3a3a3a;
            margin-right: 4px;
            cursor: pointer;
            transition: all 0.1s;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 10px;
        }
        
        .caption-step-cell:hover {
            background-color: #5a5a5a;
        }
        
        .caption-step-cell.active {
            background-color: #ffffff;
            border-color: #a82a2a;
        }
        
        .caption-step-cell.current {
            box-shadow: 0 0 10px #fff;
            position: relative;
            z-index: 1;
        }
        
        /* å¸®åŠ©çª—å£æ ·å¼ - ä¿æŒä¸å˜ */
        .help-window {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 600px;
            max-width: 90%;
            max-height: 80vh;
            background-color: #2a2a2a;
            border: 8px solid #1a1a1a;
            border-radius: 4px;
            padding: 20px;
            z-index: 2000;
            display: none;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.7);
            overflow-y: auto;
        }
        
        .help-window.active {
            display: block;
        }
        
        .help-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 4px solid #1a1a1a;
        }
        
        .help-title {
            color: #f8d038;
            font-size: 18px;
            text-shadow: 2px 2px 0 #a82a2a;
        }
        
        .help-close {
            background: none;
            border: none;
            color: #fff;
            font-size: 24px;
            cursor: pointer;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 2px;
        }
        
        .help-close:hover {
            background-color: #4a4a4a;
        }
        
        .help-content {
            font-family: Arial, sans-serif;
            font-size: 14px;
            line-height: 1.6;
            color: #fff;
            user-select: text; /* å…è®¸é€‰æ‹©å¸®åŠ©æ–‡æœ¬ */
        }
        
        .help-content h3 {
            color: #f8d038;
            margin: 15px 0 10px 0;
            font-size: 16px;
        }
        
        .help-content ul {
            margin: 10px 0 10px 20px;
        }
        
        .help-content li {
            margin-bottom: 8px;
        }
        
        .help-content p {
            margin-bottom: 10px;
        }
        
        .help-content code {
            background-color: #4a4a4a;
            padding: 2px 5px;
            border-radius: 2px;
            font-family: 'Courier New', monospace;
        }
        
        .help-content .credits {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 2px solid #1a1a1a;
            color: #a8e0f0;
            font-style: italic;
        }
        
        /* é®ç½©å±‚æ ·å¼ - ä¿æŒä¸å˜ */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1500;
            display: none;
        }
        
        .overlay.active {
            display: block;
        }
    </style>
</head>
<body>
    <!-- å…¨å±æŒ‰é’® -->
    <button class="fullscreen-btn" id="fullscreenBtn">FULLSCREEN</button>
    
    <!-- å¸®åŠ©çª—å£é®ç½©å±‚ -->
    <div class="overlay" id="overlay"></div>
    
    <!-- å¸®åŠ©çª—å£ -->
    <div class="help-window" id="helpWindow">
        <div class="help-header">
            <div class="help-title">FCé«˜çº§é¼“æœºéŸ³åºå™¨ ä½¿ç”¨å¸®åŠ©</div>
            <button class="help-close" id="helpClose">Ã—</button>
        </div>
        <div class="help-content" id="helpContent">
            <h3>è½¯ä»¶ç®€ä»‹</h3>
            <p>FCé«˜çº§é¼“æœºéŸ³åºå™¨æ˜¯ä¸€æ¬¾å¤å¤FC/Nintendoé£æ ¼çš„é¼“æœºå’Œåˆæˆå™¨éŸ³åºå™¨ï¼Œçµæ„Ÿæ¥æºäºç»å…¸çš„èŠ¯ç‰‡éŸ³ä¹ã€‚</p>
            
            <h3>åŸºæœ¬æ“ä½œ</h3>
            <ul>
                <li><strong>æ’­æ”¾/æš‚åœ</strong>ï¼šç‚¹å‡»â–¶ PLAYæŒ‰é’®æˆ–æŒ‰ç©ºæ ¼é”®</li>
                <li><strong>åœæ­¢</strong>ï¼šç‚¹å‡»â–  STOPæŒ‰é’®æˆ–æŒ‰ESCé”®</li>
                <li><strong>å¾ªç¯æ¨¡å¼</strong>ï¼šç‚¹å‡»LOOPæŒ‰é’®æˆ–æŒ‰å·¦Ctrlé”®</li>
                <li><strong>BPMè°ƒæ•´</strong>ï¼šä½¿ç”¨BPMæ»‘å—è°ƒæ•´èŠ‚å¥é€Ÿåº¦</li>
                <li><strong>æ‹å·åˆ‡æ¢</strong>ï¼š4/4æ‹æˆ–6/8æ‹</li>
            </ul>
            
            <h3>éŸ³åºå™¨ä½¿ç”¨</h3>
            <ul>
                <li><strong>æ”¾ç½®/ç§»é™¤éŸ³ç¬¦</strong>ï¼šç‚¹å‡»ç½‘æ ¼ä¸­çš„æ ¼å­</li>
                <li><strong>è°ƒæ•´éŸ³é«˜</strong>ï¼šå³é”®ç‚¹å‡»éŸ³é«˜è½¨é“æ ¼å­åº”ç”¨é€‰ä¸­çš„éŸ³ç¬¦</li>
                <li><strong>å¸å–éŸ³é«˜</strong>ï¼šShift+å·¦é”®ç‚¹å‡»å·²æ¿€æ´»çš„éŸ³ç¬¦æ ¼å­</li>
                <li><strong>é™éŸ³è½¨é“</strong>ï¼šç‚¹å‡»è½¨é“åç§°åˆ‡æ¢é™éŸ³çŠ¶æ€</li>
            </ul>
            
            <h3>é’¢ç´é”®ç›˜</h3>
            <ul>
                <li><strong>é€‰æ‹©éŸ³ç¬¦</strong>ï¼šç‚¹å‡»é’¢ç´é”®ç›˜ä¸Šçš„ç´é”®</li>
                <li><strong>è°ƒæ•´å…«åº¦</strong>ï¼šä½¿ç”¨+/- OCTAVEæŒ‰é’®æˆ–Z/Xé”®</li>
                <li><strong>è°ƒæ•´åŠéŸ³</strong>ï¼šä½¿ç”¨Q/Wé”®é™ä½/å‡é«˜åŠéŸ³</li>
            </ul>
            
            <h3>Patternç®¡ç†</h3>
            <ul>
                <li><strong>æ·»åŠ Pattern</strong>ï¼šç‚¹å‡»+ ADDæŒ‰é’®</li>
                <li><strong>å¤åˆ¶Pattern</strong>ï¼šç‚¹å‡»COPYæŒ‰é’®</li>
                <li><strong>é‡å‘½åPattern</strong>ï¼šç‚¹å‡»RENAMEæŒ‰é’®</li>
                <li><strong>ç§»åŠ¨Pattern</strong>ï¼šä½¿ç”¨â—€ MOVEå’ŒMOVE â–¶æŒ‰é’®</li>
                <li><strong>åˆ é™¤Pattern</strong>ï¼šç‚¹å‡»- REMOVEæŒ‰é’®</li>
                <li><strong>åˆ‡æ¢Pattern</strong>ï¼šç‚¹å‡»Patternåˆ—è¡¨ä¸­çš„é¡¹ç›®æˆ–ä½¿ç”¨å·¦å³ç®­å¤´é”®</li>
            </ul>
            
            <h3>å­—å¹•éŸ³åºå™¨</h3>
            <ul>
                <li><strong>æ˜¾ç¤º/éšè—</strong>ï¼šç‚¹å‡»CAPTIONæŒ‰é’®æˆ–æŒ‰Ctrl+C</li>
                <li><strong>æ”¾ç½®/ç§»é™¤å­—å¹•</strong>ï¼šå·¦é”®ç‚¹å‡»å­—å¹•æ ¼å­</li>
                <li><strong>ç¼–è¾‘å­—å¹•</strong>ï¼šå³é”®ç‚¹å‡»å­—å¹•æ ¼å­è¾“å…¥æ–‡å­—ï¼ˆæ”¯æŒç©ºæ ¼ï¼‰</li>
                <li><strong>é¢„è§ˆå­—å¹•</strong>ï¼šé¼ æ ‡æ‚¬åœåœ¨å­—å¹•æ ¼å­ä¸Šé¢„è§ˆ</li>
                <li><strong>å­—å¹•æ˜¾ç¤º</strong>ï¼šæ’­æ”¾æ—¶ï¼Œå­—å¹•ä¼šåœ¨è¶£å‘³æ˜¾ç¤ºå™¨ä¸­æ˜¾ç¤ºï¼ˆä»…åœ¨å­—å¹•éŸ³åºå™¨æ‰“å¼€æ—¶å¯è§ï¼‰</li>
            </ul>
            
            <h3>é«˜çº§è®¾ç½®</h3>
            <ul>
                <li><strong>æ˜¾ç¤º/éšè—</strong>ï¼šç‚¹å‡»ADVANCEæŒ‰é’®</li>
                <li><strong>å‚æ•°è°ƒæ•´</strong>ï¼šæ¯ä¸ªè½¨é“éƒ½æœ‰ç‹¬ç«‹çš„å‚æ•°æ§åˆ¶</li>
                <li><strong>é¢¤éŸ³æ•ˆæœ</strong>ï¼šæ—‹å¾‹è½¨é“å¯è°ƒæ•´é¢¤éŸ³é€Ÿåº¦ã€æ·±åº¦å’Œattackæ—¶é—´</li>
                <li><strong>ä½å‹æ•ˆæœ</strong>ï¼šä¸‰è§’æ³¢è½¨é“æœ‰BITCRUSHæ§åˆ¶ï¼Œå¯æ¨¡æ‹Ÿ8ä½æ¸¸æˆæœºéŸ³è´¨</li>
            </ul>
            
            <h3>æ–‡ä»¶æ“ä½œ</h3>
            <ul>
                <li><strong>æ–°å»ºå·¥ç¨‹</strong>ï¼šç‚¹å‡»NEWæŒ‰é’®æˆ–æŒ‰Ctrl+N</li>
                <li><strong>æ¸…é™¤å½“å‰Pattern</strong>ï¼šç‚¹å‡»CLEARæŒ‰é’®</li>
                <li><strong>å¯¼å‡ºæ­Œæ›²</strong>ï¼šç‚¹å‡»EXPORT SONGæŒ‰é’®</li>
                <li><strong>å¯¼å…¥æ­Œæ›²</strong>ï¼šç‚¹å‡»IMPORT SONGæŒ‰é’®é€‰æ‹©.songæ–‡ä»¶</li>
            </ul>
            
            <h3>å…¶ä»–åŠŸèƒ½</h3>
            <ul>
                <li><strong>å…¨å±æ¨¡å¼</strong>ï¼šç‚¹å‡»FULLSCREENæŒ‰é’®æˆ–æŒ‰Fé”®</li>
                <li><strong>è¶£å‘³å¯è§†åŒ–</strong>ï¼šæ’­æ”¾æ—¶ä¼šæ˜¾ç¤ºğŸ‘¾è¡¨æƒ…åŠ¨ç”»</li>
                <li><strong>æ³¢å½¢å¯è§†åŒ–</strong>ï¼šå®æ—¶æ˜¾ç¤ºéŸ³é¢‘æ³¢å½¢</li>
            </ul>
            
            <h3>é”®ç›˜å¿«æ·é”®</h3>
            <ul>
                <li><code>ç©ºæ ¼é”®</code> - æ’­æ”¾/æš‚åœ</li>
                <li><code>ESC</code> - åœæ­¢æ’­æ”¾</li>
                <li><code>å·¦Ctrl</code> - åˆ‡æ¢å¾ªç¯æ¨¡å¼</li>
                <li><code>å·¦å³ç®­å¤´</code> - åˆ‡æ¢Pattern</li>
                <li><code>Z/X</code> - é™ä½/æé«˜å…«åº¦</li>
                <li><code>Q/W</code> - é™ä½/å‡é«˜åŠéŸ³</li>
                <li><code>F</code> - åˆ‡æ¢å…¨å±</li>
                <li><code>Ctrl+N</code> - æ–°å»ºå·¥ç¨‹</li>
                <li><code>Ctrl+C</code> - åˆ‡æ¢å­—å¹•éŸ³åºå™¨</li>
                <li><code>Ctrl+H</code> - åˆ‡æ¢å¸®åŠ©çª—å£</li>
                <li><code>1-7æ•°å­—é”®</code> - é€‰æ‹©é’¢ç´é”®ç›˜ç™½é”®</li>
            </ul>
            
            <div class="credits">
                <p>FC Advanced Drum Sequencer</p>
                <p>Created by FJZ with assistance from Deepseek</p>
                <p>Version 1.3 - æ–°å¢ä¸‰è§’æ³¢Bufferå’ŒBitcrushæ•ˆæœ</p>
            </div>
        </div>
    </div>
    
    <div class="container">
        <!-- æ ‡é¢˜åŒºåŸŸ -->
        <div class="header">
            <h1>FC ADVANCED DRUM SEQUENCER</h1>
            <div class="subtitle">RETRO NINTENDO-STYLE DRUM & SYNTH SEQUENCER</div>
        </div>
        
        <!-- æ§åˆ¶é¢æ¿ -->
        <div class="control-panel">
            <div class="bpm-control">
                <div class="bpm-label">BPM:</div>
                <div class="bpm-value">120</div>
                <input type="range" min="60" max="200" value="120" class="bpm-slider" id="bpmSlider">
            </div>
            
            <div class="time-signature">
                <div class="time-signature-label">TIME SIG:</div>
                <div class="time-signature-buttons">
                    <button class="btn active" data-time="4">4/4</button>
                    <button class="btn" data-time="6">6/8</button>
                </div>
            </div>
            
            <div class="transport-controls">
                <button class="btn btn-play" id="playBtn">â–¶ PLAY</button>
                <button class="btn" id="loopBtn">LOOP</button>
                <button class="btn btn-stop" id="stopBtn">â–  STOP</button>
                <button class="btn btn-new" id="newBtn">NEW</button>
                <button class="btn" id="clearBtn">CLEAR</button>
                <button class="btn" id="advanceBtn">ADVANCE</button>
                <button class="btn btn-caption" id="captionBtn">CAPTION</button>
                <button class="btn btn-help" id="helpBtn">HELP</button>
            </div>
        </div>
        
        <!-- Blockæ§åˆ¶åŒºåŸŸ -->
        <div class="block-controls">
            <div class="block-header">
                <div class="block-title">PATTERN BLOCKS</div>
                <div class="block-buttons">
                    <button class="btn" id="addBlockBtn">+ ADD</button>
                    <button class="btn" id="removeBlockBtn">- REMOVE</button>
                    <button class="btn" id="duplicateBlockBtn">COPY</button>
                    <button class="btn" id="renameBlockBtn">RENAME</button>
                    <button class="btn" id="moveLeftBtn">â—€ MOVE</button>
                    <button class="btn" id="moveRightBtn">MOVE â–¶</button>
                </div>
            </div>
            <div class="blocks-list" id="blocksList">
                <!-- Blockåˆ—è¡¨å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
        
        <!-- æ³¢å½¢å¯è§†åŒ–åŒºåŸŸ -->
        <div class="visualizer" id="visualizer">
            <div class="beat-indicator" id="beatIndicator"></div>
            <div class="waveform" id="waveform"></div>
        </div>
        
        <!-- è¶£å‘³å¯è§†åŒ–åŒºåŸŸ -->
        <div class="fun-visualizer" id="funVisualizer">
            <div class="caption-display" id="captionDisplay"></div>
            <!-- ğŸ‘¾ emojiå°†åœ¨è¿™é‡ŒåŠ¨æ€æ˜¾ç¤º -->
        </div>
        
        <!-- é«˜çº§è®¾ç½®åŒºåŸŸ -->
        <div class="advance-settings" id="advanceSettings">
            <div class="settings-header">
                <div class="settings-title">ADVANCED SETTINGS</div>
            </div>
            <div class="settings-content" id="settingsContent">
                <!-- è®¾ç½®å†…å®¹å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
        
        <!-- éŸ³åºå™¨ç½‘æ ¼ -->
        <div class="sequencer-grid" id="sequencerGrid">
            <!-- éŸ³åºå™¨ç½‘æ ¼å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
        </div>
        
        <!-- å­—å¹•éŸ³åºå™¨åŒºåŸŸ -->
        <div class="caption-sequencer" id="captionSequencer">
            <div class="caption-header">
                <div class="caption-title">CAPTION SEQUENCER (Left-click to place/remove, Right-click to edit text)</div>
            </div>
            <div class="caption-row">
                <div class="caption-label">CAPTION</div>
                <div class="caption-step-cells" id="captionStepCells">
                    <!-- å­—å¹•æ­¥è¿›æ ¼å­å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
        </div>
        
        <!-- é’¢ç´é”®ç›˜åŒºåŸŸ -->
        <div class="piano-container">
            <div class="piano-header">
                <div class="piano-title">PIANO KEYBOARD (Right-click cells to apply selected note)</div>
                <div class="piano-controls">
                    <button class="btn" id="octaveDownBtn">- OCTAVE</button>
                    <div class="bpm-value" id="currentOctave">4</div>
                    <button class="btn" id="octaveUpBtn">+ OCTAVE</button>
                </div>
            </div>
            <div class="piano-keyboard" id="pianoKeyboard">
                <!-- é’¢ç´é”®ç›˜å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
        
        <!-- æ­Œæ›²å¯¼å‡ºåŒºåŸŸ -->
        <div class="song-export">
            <div class="song-header">
                <div class="song-title">SONG IMPORT/EXPORT</div>
                <div class="song-buttons">
                    <button class="btn" id="exportBtn">EXPORT SONG</button>
                    <label for="importFile" class="file-label">IMPORT SONG</label>
                    <input type="file" id="importFile" class="file-input" accept=".song">
                </div>
            </div>
        </div>
    </div>

    <script>
        // åˆå§‹åŒ–éŸ³é¢‘ä¸Šä¸‹æ–‡
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        const audioContext = new AudioContext();
        
        // å…¨å±€å˜é‡
        let isPlaying = false;
        let loopCurrentPattern = false;
        let currentStep = 0;
        let currentPatternStep = 0;
        let bpm = 120;
        let timerId = null;
        let timeSignature = 4; // 4/4æ‹
        let stepCount = 16; // åŸºäºæ‹å·
        let currentBlock = 0;
        let blocks = []; // å­˜å‚¨æ‰€æœ‰blockçš„æ•°æ®
        let mutedTracks = {}; // å­˜å‚¨é™éŸ³çš„è½¨é“
        let selectedNote = 60; // å½“å‰é€‰ä¸­çš„éŸ³ç¬¦ (C4)
        let currentOctave = 4; // å½“å‰å…«åº¦
        let isCaptionVisible = false; // å­—å¹•éŸ³åºå™¨æ˜¯å¦å¯è§
        let currentCaption = ""; // å½“å‰æ˜¾ç¤ºçš„å­—å¹•
        let isPageVisible = true; // é¡µé¢æ˜¯å¦å¯è§ï¼ˆç”¨äºæ€§èƒ½ä¼˜åŒ–ï¼‰
        let isHelpVisible = false; // å¸®åŠ©çª—å£æ˜¯å¦å¯è§
        
        // éŸ³é«˜è½¨é“é…ç½®
        const pitchTracks = [
            { id: 'triangle', name: 'TRIANGLE', color: 'triangle', defaultNote: 60, noteRange: [36, 84], type: 'triangle' },
            { id: 'square_a', name: 'SQUARE A', color: 'square_a', defaultNote: 64, noteRange: [36, 84], type: 'square' },
            { id: 'square_b', name: 'SQUARE B', color: 'square_b', defaultNote: 67, noteRange: [36, 84], type: 'square' },
            { id: 'sawtooth', name: 'SAWTOOTH', color: 'sawtooth', defaultNote: 60, noteRange: [36, 84], type: 'sawtooth' }
        ];
        
        // é¼“è½¨é“é…ç½®
        const drumTypes = [
            { id: 'kick', name: 'KICK', color: 'kick' },
            { id: 'snare', name: 'SNARE', color: 'snare' },
            { id: 'hihat', name: 'HIHAT', color: 'hihat' },
            { id: 'openhat', name: 'OPENHAT', color: 'openhat' },
            { id: 'clap', name: 'CLAP', color: 'clap' }
        ];
        
        // æ‰€æœ‰è½¨é“åˆå¹¶ï¼ˆä¸åŒ…æ‹¬å­—å¹•è½¨é“ï¼‰
        const allTracks = [...drumTypes, ...pitchTracks];
        
        // é»˜è®¤é«˜çº§è®¾ç½®å‚æ•° - å°†æ‰€æœ‰éŸ³ç¬¦è½¨é“çš„é¢¤éŸ³å‚æ•°è®¾ç½®ä¸º0
        const defaultTrackSettings = {
            kick: { attack: 0.01, decay: 0.3, tone: 150, volume: 1.0 },
            snare: { noise: 0.7, tone: 200, decay: 0.2, volume: 1.0 },
            hihat: { decay: 0.1, tone: 7000, volume: 1.0 },
            openhat: { decay: 0.5, tone: 5000, volume: 1.0 },
            clap: { delay: 0.03, count: 3, decay: 0.1, volume: 1.0 },
            triangle: { attack: 0.01, decay: 0.2, volume: 0.5, vibratoSpeed: 0, vibratoDepth: 0, vibratoAttack: 0, bitcrush: 0.0 },
            square_a: { attack: 0.01, decay: 0.2, volume: 0.5, duty: 0.5, vibratoSpeed: 0, vibratoDepth: 0, vibratoAttack: 0 },
            square_b: { attack: 0.01, decay: 0.2, volume: 0.5, duty: 0.5, vibratoSpeed: 0, vibratoDepth: 0, vibratoAttack: 0 },
            sawtooth: { attack: 0.01, decay: 0.2, volume: 0.5, vibratoSpeed: 0, vibratoDepth: 0, vibratoAttack: 0 }
        };
        
        // å½“å‰é«˜çº§è®¾ç½®å‚æ•°
        let trackSettings = JSON.parse(JSON.stringify(defaultTrackSettings));
        
        // ä¸»é¢˜è‰²å¯¹åº”çš„ğŸ‘¾è¡¨æƒ…ç¬¦å·
        const themeEmojis = ['ğŸ‘¾', 'ğŸ‘¾', 'ğŸ‘¾', 'ğŸ‘¾', 'ğŸ‘¾', 'ğŸ‘¾', 'ğŸ‘¾', 'ğŸ‘¾'];
        
        // æ³¢å½¢å¯è§†åŒ–ä¸»é¢˜è‰²
        const waveformColors = ['#a8e0f0', '#f8d038', '#3a9e3a', '#a82a2a', '#e080c0', '#8a6df0', '#ffaa55', '#55aaff'];
        
        // DOMå…ƒç´ 
        const playBtn = document.getElementById('playBtn');
        const loopBtn = document.getElementById('loopBtn');
        const stopBtn = document.getElementById('stopBtn');
        const newBtn = document.getElementById('newBtn');
        const clearBtn = document.getElementById('clearBtn');
        const advanceBtn = document.getElementById('advanceBtn');
        const captionBtn = document.getElementById('captionBtn');
        const helpBtn = document.getElementById('helpBtn');
        const fullscreenBtn = document.getElementById('fullscreenBtn');
        const bpmSlider = document.getElementById('bpmSlider');
        const bpmValue = document.querySelector('.bpm-value');
        const timeSignatureBtns = document.querySelectorAll('.time-signature-buttons .btn');
        const sequencerGrid = document.getElementById('sequencerGrid');
        const beatIndicator = document.getElementById('beatIndicator');
        const waveform = document.getElementById('waveform');
        const funVisualizer = document.getElementById('funVisualizer');
        const captionDisplay = document.getElementById('captionDisplay');
        const captionSequencer = document.getElementById('captionSequencer');
        const captionStepCells = document.getElementById('captionStepCells');
        const advanceSettings = document.getElementById('advanceSettings');
        const settingsContent = document.getElementById('settingsContent');
        const blocksList = document.getElementById('blocksList');
        const addBlockBtn = document.getElementById('addBlockBtn');
        const removeBlockBtn = document.getElementById('removeBlockBtn');
        const duplicateBlockBtn = document.getElementById('duplicateBlockBtn');
        const renameBlockBtn = document.getElementById('renameBlockBtn');
        const moveLeftBtn = document.getElementById('moveLeftBtn');
        const moveRightBtn = document.getElementById('moveRightBtn');
        const pianoKeyboard = document.getElementById('pianoKeyboard');
        const octaveDownBtn = document.getElementById('octaveDownBtn');
        const octaveUpBtn = document.getElementById('octaveUpBtn');
        const currentOctaveDisplay = document.getElementById('currentOctave');
        const exportBtn = document.getElementById('exportBtn');
        const importFile = document.getElementById('importFile');
        const helpWindow = document.getElementById('helpWindow');
        const helpClose = document.getElementById('helpClose');
        const overlay = document.getElementById('overlay');
        
        // åˆå§‹åŒ–åº”ç”¨ç¨‹åº
        function init() {
            // åˆå§‹åŒ–blocks
            initBlocks();
            
            // åˆå§‹åŒ–æ³¢å½¢å¯è§†åŒ–
            initWaveform();
            
            // åˆå§‹åŒ–é«˜çº§è®¾ç½®
            renderAdvancedSettings();
            
            // åˆå§‹åŒ–é’¢ç´é”®ç›˜
            renderPianoKeyboard();
            
            // åˆå§‹åŒ–å­—å¹•éŸ³åºå™¨
            initCaptionSequencer();
            
            // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
            setupEventListeners();
            
            // æ·»åŠ é»˜è®¤patternç”¨äºæ¼”ç¤º
            addDefaultPattern();
            
            // ç›‘å¬é¡µé¢å¯è§æ€§å˜åŒ–ï¼ˆç”¨äºæ€§èƒ½ä¼˜åŒ–ï¼‰
            document.addEventListener('visibilitychange', handleVisibilityChange);
            
            // é˜²æ­¢ç¨‹åºè‡ªåŠ¨æ»šåŠ¨
            window.addEventListener('scroll', function(e) {
                // å¦‚æœæ»šåŠ¨ä¸æ˜¯ç”¨æˆ·è§¦å‘çš„ï¼Œé˜»æ­¢å®ƒ
                if (!e.isTrusted) {
                    window.scrollTo(0, 0);
                }
            });
        }
        
        // å¤„ç†é¡µé¢å¯è§æ€§å˜åŒ–
        function handleVisibilityChange() {
            isPageVisible = !document.hidden;
        }
        
        // åˆå§‹åŒ–blocksæ•°æ®
        function initBlocks() {
            blocks = [];
            // åˆ›å»ºé»˜è®¤block
            addNewBlock();
        }
        
        // æ·»åŠ æ–°çš„block
        function addNewBlock() {
            const blockId = blocks.length;
            const blockData = {
                id: blockId,
                name: `Pattern ${blockId + 1}`,
                data: {},
                caption: new Array(stepCount).fill("") // å­—å¹•æ•°æ®
            };
            
            // ä¸ºæ¯ä¸ªè½¨é“åˆå§‹åŒ–åºåˆ—æ•°æ®
            allTracks.forEach(track => {
                if (pitchTracks.includes(track)) {
                    // éŸ³é«˜è½¨é“ï¼šå­˜å‚¨æ¿€æ´»çŠ¶æ€å’ŒéŸ³ç¬¦å€¼
                    blockData.data[track.id] = {
                        active: new Array(stepCount).fill(false),
                        notes: new Array(stepCount).fill(track.defaultNote)
                    };
                } else {
                    // é¼“è½¨é“ï¼šåªå­˜å‚¨æ¿€æ´»çŠ¶æ€
                    blockData.data[track.id] = new Array(stepCount).fill(false);
                }
            });
            
            blocks.push(blockData);
            renderBlocksList();
            setCurrentBlock(blockId);
        }
        
        // å¤åˆ¶å½“å‰block
        function duplicateCurrentBlock() {
            const currentBlockData = blocks[currentBlock];
            const newBlockId = blocks.length;
            
            // æ·±æ‹·è´å½“å‰blockæ•°æ®
            const newBlockData = {
                id: newBlockId,
                name: `${currentBlockData.name} Copy`,
                data: JSON.parse(JSON.stringify(currentBlockData.data)),
                caption: [...currentBlockData.caption] // å¤åˆ¶å­—å¹•æ•°æ®
            };
            
            blocks.push(newBlockData);
            renderBlocksList();
            setCurrentBlock(newBlockId);
        }
        
        // é‡å‘½åå½“å‰block
        function renameCurrentBlock() {
            const currentBlockData = blocks[currentBlock];
            const newName = prompt('Enter new pattern name:', currentBlockData.name);
            
            if (newName && newName.trim() !== '') {
                currentBlockData.name = newName.trim();
                renderBlocksList();
            }
        }
        
        // å°†blockå‘å·¦ç§»åŠ¨
        function moveBlockLeft() {
            if (currentBlock <= 0) return;
            
            // äº¤æ¢blockä½ç½®
            [blocks[currentBlock], blocks[currentBlock - 1]] = [blocks[currentBlock - 1], blocks[currentBlock]];
            
            // æ›´æ–°ID
            blocks.forEach((block, index) => {
                block.id = index;
            });
            
            currentBlock--;
            renderBlocksList();
        }
        
        // å°†blockå‘å³ç§»åŠ¨
        function moveBlockRight() {
            if (currentBlock >= blocks.length - 1) return;
            
            // äº¤æ¢blockä½ç½®
            [blocks[currentBlock], blocks[currentBlock + 1]] = [blocks[currentBlock + 1], blocks[currentBlock]];
            
            // æ›´æ–°ID
            blocks.forEach((block, index) => {
                block.id = index;
            });
            
            currentBlock++;
            renderBlocksList();
        }
        
        // åˆ é™¤å½“å‰block
        function removeCurrentBlock() {
            if (blocks.length <= 1) {
                alert('Cannot delete the last pattern!');
                return;
            }
            
            blocks.splice(currentBlock, 1);
            
            // æ›´æ–°æ‰€æœ‰blockçš„ID
            blocks.forEach((block, index) => {
                block.id = index;
            });
            
            // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰blockï¼Œåˆ‡æ¢åˆ°å‰ä¸€ä¸ªblock
            if (currentBlock >= blocks.length) {
                currentBlock = blocks.length - 1;
            }
            
            renderBlocksList();
            setCurrentBlock(currentBlock);
        }
        
        // è®¾ç½®å½“å‰block
        function setCurrentBlock(blockId) {
            currentBlock = blockId;
            renderBlocksList();
            renderSequencerGrid();
            renderCaptionSequencer();
        }
        
        // æ¸²æŸ“blockåˆ—è¡¨
        function renderBlocksList() {
            blocksList.innerHTML = '';
            
            blocks.forEach(block => {
                const blockItem = document.createElement('div');
                blockItem.className = `block-item ${block.id === currentBlock ? 'active' : ''}`;
                blockItem.textContent = block.name;
                blockItem.addEventListener('click', () => {
                    setCurrentBlock(block.id);
                });
                blocksList.appendChild(blockItem);
            });
            
            // æ»šåŠ¨åˆ°å½“å‰block
            const activeBlock = blocksList.querySelector('.active');
            if (activeBlock) {
                activeBlock.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
            }
        }
        
        // æ ¹æ®æ‹å·æ›´æ–°æ­¥æ•°
        function updateStepCount() {
            switch(timeSignature) {
                case 6: // 6/8æ‹
                    stepCount = 12;
                    break;
                default: // 4/4æ‹
                    stepCount = 16;
            }
            
            // æ›´æ–°æ‰€æœ‰blockä¸­æ•°æ®çš„é•¿åº¦
            blocks.forEach(block => {
                allTracks.forEach(track => {
                    if (pitchTracks.includes(track)) {
                        // éŸ³é«˜è½¨é“
                        const oldActive = block.data[track.id]?.active || [];
                        const oldNotes = block.data[track.id]?.notes || [];
                        
                        if (!block.data[track.id]) {
                            block.data[track.id] = {
                                active: new Array(stepCount).fill(false),
                                notes: new Array(stepCount).fill(track.defaultNote)
                            };
                        } else {
                            block.data[track.id].active = resizeArray(oldActive, stepCount, false);
                            block.data[track.id].notes = resizeArray(oldNotes, stepCount, track.defaultNote);
                        }
                    } else {
                        // é¼“è½¨é“
                        const oldData = block.data[track.id] || [];
                        block.data[track.id] = resizeArray(oldData, stepCount, false);
                    }
                });
                
                // æ›´æ–°å­—å¹•æ•°æ®é•¿åº¦
                if (!block.caption) {
                    block.caption = new Array(stepCount).fill("");
                } else {
                    block.caption = resizeArray(block.caption, stepCount, "");
                }
            });
            
            // é‡æ–°æ¸²æŸ“éŸ³åºå™¨ç½‘æ ¼å’Œå­—å¹•éŸ³åºå™¨
            renderSequencerGrid();
            initCaptionSequencer(); // é‡æ–°åˆå§‹åŒ–å­—å¹•éŸ³åºå™¨ä»¥æ˜¾ç¤ºæ­£ç¡®æ•°é‡çš„æ ¼å­
        }
        
        // è°ƒæ•´æ•°ç»„å¤§å°
        function resizeArray(arr, newSize, defaultValue) {
            if (arr.length === newSize) return arr;
            
            const newArr = new Array(newSize).fill(defaultValue);
            const minLength = Math.min(arr.length, newSize);
            
            for (let i = 0; i < minLength; i++) {
                newArr[i] = arr[i];
            }
            
            return newArr;
        }
        
        // æ¸²æŸ“éŸ³åºå™¨ç½‘æ ¼
        function renderSequencerGrid() {
            sequencerGrid.innerHTML = '';
            
            allTracks.forEach((track, rowIndex) => {
                const drumRow = document.createElement('div');
                drumRow.className = 'drum-row';
                
                const drumLabel = document.createElement('div');
                drumLabel.className = `drum-label ${mutedTracks[track.id] ? 'muted' : ''}`;
                drumLabel.textContent = track.name;
                drumLabel.addEventListener('click', () => {
                    toggleMuteTrack(track.id);
                });
                drumRow.appendChild(drumLabel);
                
                const stepCells = document.createElement('div');
                stepCells.className = 'step-cells';
                
                // åˆ›å»ºæ­¥è¿›æ ¼å­
                for (let step = 0; step < stepCount; step++) {
                    const stepCell = document.createElement('div');
                    stepCell.className = 'step-cell';
                    stepCell.dataset.track = track.id;
                    stepCell.dataset.step = step;
                    
                    // è·å–å½“å‰blockçš„æ•°æ®
                    const blockData = blocks[currentBlock].data[track.id];
                    
                    // è®¾ç½®åˆå§‹æ¿€æ´»çŠ¶æ€
                    if (pitchTracks.includes(track)) {
                        // éŸ³é«˜è½¨é“
                        if (blockData && blockData.active[step]) {
                            stepCell.classList.add('active');
                            stepCell.classList.add(track.color);
                            
                            // æ·»åŠ éŸ³ç¬¦æ˜¾ç¤º
                            const noteValue = document.createElement('div');
                            noteValue.className = 'note-value';
                            noteValue.textContent = midiToNote(blockData.notes[step]);
                            stepCell.appendChild(noteValue);
                        }
                    } else {
                        // é¼“è½¨é“
                        if (blockData && blockData[step]) {
                            stepCell.classList.add('active');
                            stepCell.classList.add(track.color);
                        }
                    }
                    
                    // ç‚¹å‡»äº‹ä»¶å¤„ç†
                    if (pitchTracks.includes(track)) {
                        // éŸ³é«˜è½¨é“ï¼šå·¦é”®ç‚¹å‡»åˆ‡æ¢æ¿€æ´»çŠ¶æ€ï¼Œå³é”®ç‚¹å‡»åº”ç”¨é€‰ä¸­çš„éŸ³ç¬¦
                        stepCell.addEventListener('click', (e) => {
                            // æ£€æŸ¥æ˜¯å¦æ˜¯Shift+å·¦é”®ï¼ˆç”¨äºå¸å–éŸ³é«˜ï¼‰
                            if (e.shiftKey && e.button === 0) {
                                e.preventDefault();
                                const step = parseInt(stepCell.dataset.step);
                                const trackId = stepCell.dataset.track;
                                
                                // å¦‚æœè¯¥æ ¼å­æœ‰æ¿€æ´»çš„éŸ³ç¬¦ï¼Œå¸å–å®ƒçš„éŸ³é«˜
                                if (blocks[currentBlock].data[trackId] && blocks[currentBlock].data[trackId].active[step]) {
                                    const note = blocks[currentBlock].data[trackId].notes[step];
                                    selectedNote = note;
                                    
                                    // æ›´æ–°é’¢ç´é”®ç›˜æ˜¾ç¤º
                                    renderPianoKeyboard();
                                    
                                    // æ’­æ”¾é¢„è§ˆå£°éŸ³
                                    playSoundPreview(note, trackId);
                                }
                                return;
                            }
                            
                            if (e.button === 0) { // å·¦é”®
                                const step = parseInt(stepCell.dataset.step);
                                const trackId = stepCell.dataset.track;
                                
                                blocks[currentBlock].data[trackId].active[step] = !blocks[currentBlock].data[trackId].active[step];
                                
                                // å¦‚æœæ¿€æ´»äº†ï¼Œæ’­æ”¾é¢„è§ˆå£°éŸ³
                                if (blocks[currentBlock].data[trackId].active[step]) {
                                    playSoundPreview(blocks[currentBlock].data[trackId].notes[step], trackId);
                                }
                                
                                renderSequencerGrid();
                            }
                        });
                        
                        // å³é”®äº‹ä»¶ï¼šåº”ç”¨é€‰ä¸­çš„éŸ³ç¬¦
                        stepCell.addEventListener('contextmenu', (e) => {
                            e.preventDefault();
                            const step = parseInt(stepCell.dataset.step);
                            const trackId = stepCell.dataset.track;
                            
                            // åº”ç”¨é€‰ä¸­çš„éŸ³ç¬¦
                            blocks[currentBlock].data[trackId].notes[step] = selectedNote;
                            
                            // å¦‚æœè¯¥æ­¥æ˜¯æ¿€æ´»çŠ¶æ€ï¼Œæ’­æ”¾é¢„è§ˆ
                            if (blocks[currentBlock].data[trackId].active[step]) {
                                playSoundPreview(selectedNote, trackId);
                            }
                            
                            renderSequencerGrid();
                        });
                    } else {
                        // é¼“è½¨é“ï¼šç®€å•åˆ‡æ¢æ¿€æ´»çŠ¶æ€
                        stepCell.addEventListener('click', (e) => {
                            if (e.button === 0) { // å·¦é”®
                                const step = parseInt(stepCell.dataset.step);
                                const trackId = stepCell.dataset.track;
                                
                                blocks[currentBlock].data[trackId][step] = !blocks[currentBlock].data[trackId][step];
                                stepCell.classList.toggle('active');
                                stepCell.classList.toggle(track.color);
                                
                                // å¦‚æœæ¿€æ´»äº†ï¼Œæ’­æ”¾é¢„è§ˆå£°éŸ³
                                if (blocks[currentBlock].data[trackId][step]) {
                                    playSoundPreview(blocks[currentBlock].data[trackId][step], trackId);
                                }
                            }
                        });
                    }
                    
                    // é˜»æ­¢é»˜è®¤å³é”®èœå•
                    stepCell.addEventListener('contextmenu', (e) => {
                        e.preventDefault();
                    });
                    
                    stepCells.appendChild(stepCell);
                }
                
                drumRow.appendChild(stepCells);
                sequencerGrid.appendChild(drumRow);
            });
        }
        
        // åˆ‡æ¢è½¨é“é™éŸ³çŠ¶æ€
        function toggleMuteTrack(trackId) {
            mutedTracks[trackId] = !mutedTracks[trackId];
            renderSequencerGrid();
        }
        
        // åˆå§‹åŒ–å­—å¹•éŸ³åºå™¨
        function initCaptionSequencer() {
            captionStepCells.innerHTML = '';
            
            for (let step = 0; step < stepCount; step++) {
                const stepCell = document.createElement('div');
                stepCell.className = 'caption-step-cell';
                stepCell.dataset.step = step;
                
                // è·å–å½“å‰blockçš„å­—å¹•æ•°æ®
                const caption = blocks[currentBlock].caption[step];
                if (caption !== undefined && caption !== "") {
                    stepCell.classList.add('active');
                    
                    // æ·»åŠ å­—å¹•æ–‡æœ¬æ˜¾ç¤ºï¼ˆæ˜¾ç¤ºç¬¬ä¸€ä¸ªå­—ç¬¦ï¼‰
                    const captionText = document.createElement('div');
                    captionText.className = 'caption-text';
                    
                    // æ˜¾ç¤ºç¬¬ä¸€ä¸ªéç©ºæ ¼å­—ç¬¦ï¼Œå¦‚æœéƒ½æ˜¯ç©ºæ ¼åˆ™æ˜¾ç¤ºä¸€ä¸ªç©ºæ ¼
                    const firstNonSpace = caption.match(/[^\s]/);
                    if (firstNonSpace) {
                        captionText.textContent = firstNonSpace[0];
                    } else {
                        captionText.textContent = " "; // æ˜¾ç¤ºä¸€ä¸ªç©ºæ ¼
                        captionText.style.opacity = "0.5"; // è®©ç©ºæ ¼çœ‹èµ·æ¥æ·¡ä¸€äº›
                    }
                    
                    stepCell.appendChild(captionText);
                }
                
                // å·¦é”®ç‚¹å‡»ï¼šæ”¾ç½®/æ¶ˆé™¤å­—å¹•
                stepCell.addEventListener('click', (e) => {
                    if (e.button === 0) { // å·¦é”®
                        const step = parseInt(stepCell.dataset.step);
                        
                        if (stepCell.classList.contains('active')) {
                            // å¦‚æœå·²ç»æœ‰å­—å¹•ï¼Œæ¸…é™¤å®ƒ
                            stepCell.classList.remove('active');
                            blocks[currentBlock].caption[step] = "";
                            
                            // ç§»é™¤å­—å¹•æ–‡æœ¬
                            const existingText = stepCell.querySelector('.caption-text');
                            if (existingText) {
                                stepCell.removeChild(existingText);
                            }
                        } else {
                            // å¦‚æœæ²¡æœ‰å­—å¹•ï¼Œæ·»åŠ é»˜è®¤å­—å¹•
                            stepCell.classList.add('active');
                            blocks[currentBlock].caption[step] = "Text";
                            
                            // æ·»åŠ å­—å¹•æ–‡æœ¬æ˜¾ç¤º
                            const captionText = document.createElement('div');
                            captionText.className = 'caption-text';
                            captionText.textContent = "T"; // åªæ˜¾ç¤ºç¬¬ä¸€ä¸ªå­—ç¬¦
                            stepCell.appendChild(captionText);
                        }
                    }
                });
                
                // å³é”®ç‚¹å‡»ï¼šç¼–è¾‘å­—å¹•æ–‡æœ¬
                stepCell.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                    const step = parseInt(stepCell.dataset.step);
                    
                    // å¦‚æœæœ‰å­—å¹•æˆ–è€…è¦æ·»åŠ æ–°å­—å¹•
                    const currentText = blocks[currentBlock].caption[step] || "";
                    const newText = prompt('Enter caption text (spaces allowed):', currentText);
                    
                    if (newText !== null) {
                        if (newText.trim() === '' && newText.length === 0) {
                            // å¦‚æœè¾“å…¥ç©ºæ–‡æœ¬ï¼Œæ¸…é™¤å­—å¹•
                            stepCell.classList.remove('active');
                            blocks[currentBlock].caption[step] = "";
                            
                            // ç§»é™¤å­—å¹•æ–‡æœ¬
                            const existingText = stepCell.querySelector('.caption-text');
                            if (existingText) {
                                stepCell.removeChild(existingText);
                            }
                        } else {
                            // æ›´æ–°å­—å¹•æ–‡æœ¬
                            stepCell.classList.add('active');
                            blocks[currentBlock].caption[step] = newText;
                            
                            // æ›´æ–°æˆ–æ·»åŠ å­—å¹•æ–‡æœ¬æ˜¾ç¤º
                            let captionText = stepCell.querySelector('.caption-text');
                            if (!captionText) {
                                captionText = document.createElement('div');
                                captionText.className = 'caption-text';
                                stepCell.appendChild(captionText);
                            }
                            
                            // æ˜¾ç¤ºç¬¬ä¸€ä¸ªéç©ºæ ¼å­—ç¬¦ï¼Œå¦‚æœéƒ½æ˜¯ç©ºæ ¼åˆ™æ˜¾ç¤ºä¸€ä¸ªç©ºæ ¼
                            const firstNonSpace = newText.match(/[^\s]/);
                            if (firstNonSpace) {
                                captionText.textContent = firstNonSpace[0];
                                captionText.style.opacity = "1";
                            } else {
                                captionText.textContent = " "; // æ˜¾ç¤ºä¸€ä¸ªç©ºæ ¼
                                captionText.style.opacity = "0.5"; // è®©ç©ºæ ¼çœ‹èµ·æ¥æ·¡ä¸€äº›
                            }
                        }
                    }
                });
                
                // é¼ æ ‡æ‚¬åœé¢„è§ˆ
                stepCell.addEventListener('mouseenter', () => {
                    const step = parseInt(stepCell.dataset.step);
                    const caption = blocks[currentBlock].caption[step];
                    
                    if (caption !== undefined && caption !== "") {
                        // æ˜¾ç¤ºé¢„è§ˆï¼ˆä½¿ç”¨ä¸åŒçš„é¢œè‰²ï¼‰
                        showCaption(caption, true);
                    }
                });
                
                // é¼ æ ‡ç¦»å¼€éšè—é¢„è§ˆ
                stepCell.addEventListener('mouseleave', () => {
                    // å¦‚æœä¸æ˜¯åœ¨æ’­æ”¾çŠ¶æ€ä¸‹ï¼Œæ¸…é™¤é¢„è§ˆ
                    if (!isPlaying) {
                        hideCaptionDisplay();
                    }
                });
                
                // é˜»æ­¢é»˜è®¤å³é”®èœå•
                stepCell.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                });
                
                captionStepCells.appendChild(stepCell);
            }
        }
        
        // æ¸²æŸ“å­—å¹•éŸ³åºå™¨
        function renderCaptionSequencer() {
            // æ¸…é™¤å½“å‰æ­¥è¿›çš„è§†è§‰åé¦ˆ
            const allSteps = document.querySelectorAll('.caption-step-cell');
            allSteps.forEach(step => step.classList.remove('current'));
            
            // è·å–å½“å‰blockçš„å­—å¹•æ•°æ®
            const captionData = blocks[currentBlock].caption;
            
            // æ›´æ–°å­—å¹•æ­¥è¿›æ ¼å­
            for (let step = 0; step < stepCount; step++) {
                const stepCell = document.querySelector(`.caption-step-cell[data-step="${step}"]`);
                if (stepCell) {
                    const caption = captionData[step];
                    
                    // æ›´æ–°æ¿€æ´»çŠ¶æ€
                    if (caption !== undefined && caption !== "") {
                        stepCell.classList.add('active');
                        
                        // æ›´æ–°æˆ–æ·»åŠ å­—å¹•æ–‡æœ¬æ˜¾ç¤º
                        let captionText = stepCell.querySelector('.caption-text');
                        if (!captionText) {
                            captionText = document.createElement('div');
                            captionText.className = 'caption-text';
                            stepCell.appendChild(captionText);
                        }
                        
                        // æ˜¾ç¤ºç¬¬ä¸€ä¸ªéç©ºæ ¼å­—ç¬¦ï¼Œå¦‚æœéƒ½æ˜¯ç©ºæ ¼åˆ™æ˜¾ç¤ºä¸€ä¸ªç©ºæ ¼
                        const firstNonSpace = caption.match(/[^\s]/);
                        if (firstNonSpace) {
                            captionText.textContent = firstNonSpace[0];
                            captionText.style.opacity = "1";
                        } else {
                            captionText.textContent = " "; // æ˜¾ç¤ºä¸€ä¸ªç©ºæ ¼
                            captionText.style.opacity = "0.5"; // è®©ç©ºæ ¼çœ‹èµ·æ¥æ·¡ä¸€äº›
                        }
                    } else {
                        stepCell.classList.remove('active');
                        
                        // ç§»é™¤å­—å¹•æ–‡æœ¬
                        const existingText = stepCell.querySelector('.caption-text');
                        if (existingText) {
                            stepCell.removeChild(existingText);
                        }
                    }
                }
            }
        }
        
        // æ˜¾ç¤ºå­—å¹•ï¼ˆåªåœ¨å­—å¹•éŸ³åºå™¨æ‰“å¼€æ—¶å¯è§ï¼‰
        function showCaption(text, isPreview = false) {
            if (!isCaptionVisible && !isPreview) {
                // å¦‚æœå­—å¹•éŸ³åºå™¨æœªæ‰“å¼€ï¼Œä¸”ä¸æ˜¯é¢„è§ˆï¼Œåˆ™ä¸æ˜¾ç¤º
                return;
            }
            
            if (text && text.trim() !== '') {
                captionDisplay.textContent = text;
                captionDisplay.className = `caption-display ${isPreview ? 'preview' : ''}`;
                captionDisplay.classList.add('show');
            }
        }
        
        // éšè—å­—å¹•
        function hideCaptionDisplay() {
            captionDisplay.classList.remove('show');
        }
        
        // æ¸…é™¤å­—å¹•
        function clearCaptionDisplay() {
            captionDisplay.textContent = "";
            captionDisplay.classList.remove('show');
        }
        
        // åˆå§‹åŒ–æ³¢å½¢å¯è§†åŒ–
        function initWaveform() {
            waveform.innerHTML = '';
            const barCount = 32;
            
            for (let i = 0; i < barCount; i++) {
                const bar = document.createElement('div');
                bar.className = 'waveform-bar';
                bar.style.left = `${(i / barCount) * 100}%`;
                bar.style.height = `${Math.random() * 30 + 10}px`;
                waveform.appendChild(bar);
            }
        }
        
        // æ›´æ–°æ³¢å½¢å¯è§†åŒ–
        function updateWaveform() {
            const bars = document.querySelectorAll('.waveform-bar');
            bars.forEach(bar => {
                // éšæœºæ›´æ–°é«˜åº¦ï¼Œæ¨¡æ‹ŸéŸ³é¢‘æ´»åŠ¨
                const currentHeight = parseFloat(bar.style.height);
                const newHeight = Math.max(10, currentHeight + (Math.random() * 20 - 10));
                bar.style.height = `${newHeight}px`;
                
                // éšæœºæ”¹å˜é¢œè‰²
                if (Math.random() > 0.7) {
                    bar.style.backgroundColor = waveformColors[Math.floor(Math.random() * waveformColors.length)];
                }
            });
        }
        
        // æ›´æ–°è¶£å‘³å¯è§†åŒ–
        function updateFunVisualizer(trackId, step) {
            // å¦‚æœé¡µé¢ä¸å¯è§ï¼Œä¸ç”Ÿæˆemojiï¼ˆæ€§èƒ½ä¼˜åŒ–ï¼‰
            if (!isPageVisible) return;
            
            // éšæœºé€‰æ‹©ä¸€ä¸ªğŸ‘¾è¡¨æƒ…
            const emoji = themeEmojis[Math.floor(Math.random() * themeEmojis.length)];
            
            // åˆ›å»ºè¡¨æƒ…å…ƒç´ 
            const emojiElement = document.createElement('div');
            emojiElement.className = 'emoji-char';
            emojiElement.textContent = emoji;
            emojiElement.style.fontSize = `${24 + Math.random() * 16}px`;
            
            // ä½¿ç”¨éšæœºå•ä¸€é¢œè‰²ï¼ˆä»æ³¢å½¢å¯è§†åŒ–ä¸»é¢˜è‰²ä¸­é€‰å–ï¼‰
            const randomColor = waveformColors[Math.floor(Math.random() * waveformColors.length)];
            emojiElement.style.color = randomColor;
            
            // è®¾ç½®éšæœºæ°´å¹³ä½ç½®
            const left = Math.random() * 90;
            emojiElement.style.left = `${left}%`;
            
            // æ·»åŠ åˆ°å¯è§†åŒ–åŒºåŸŸ
            funVisualizer.appendChild(emojiElement);
            
            // è·³è·ƒåŠ¨ç”»
            let jumpHeight = 0;
            const maxJump = 50;
            const jumpSpeed = 0.1;
            let direction = 1;
            
            function jump() {
                jumpHeight += direction * jumpSpeed * maxJump;
                
                if (jumpHeight >= maxJump) {
                    direction = -1;
                }
                
                emojiElement.style.bottom = `${jumpHeight}px`;
                
                if (jumpHeight > 0) {
                    requestAnimationFrame(jump);
                } else {
                    // åŠ¨ç”»ç»“æŸåç§»é™¤å…ƒç´ 
                    setTimeout(() => {
                        if (emojiElement.parentNode) {
                            emojiElement.parentNode.removeChild(emojiElement);
                        }
                    }, 1000);
                }
            }
            
            // å¼€å§‹è·³è·ƒåŠ¨ç”»
            jump();
        }
        
        // MIDIéŸ³ç¬¦è½¬æ¢ä¸ºéŸ³ç¬¦åç§°
        function midiToNote(midi) {
            const notes = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
            const octave = Math.floor(midi / 12) - 1;
            const note = notes[midi % 12];
            return note + octave;
        }
        
        // éŸ³ç¬¦åç§°è½¬æ¢ä¸ºMIDIéŸ³ç¬¦
        function noteToMidi(note) {
            const noteMap = {
                'C': 0, 'C#': 1, 'Db': 1, 'D': 2, 'D#': 3, 'Eb': 3,
                'E': 4, 'F': 5, 'F#': 6, 'Gb': 6, 'G': 7, 'G#': 8,
                'Ab': 8, 'A': 9, 'A#': 10, 'Bb': 10, 'B': 11
            };
            
            const match = note.match(/^([A-Ga-g][#b]?)(-?\d+)$/);
            if (!match) return null;
            
            const noteName = match[1].toUpperCase();
            const octave = parseInt(match[2]);
            
            if (!noteMap.hasOwnProperty(noteName)) return null;
            
            return (octave + 1) * 12 + noteMap[noteName];
        }
        
        // æ’­æ”¾å£°éŸ³é¢„è§ˆï¼ˆç”¨äºéŸ³ç¬¦é€‰æ‹©å’ŒéŸ³é«˜è°ƒæ•´ï¼‰- ä½¿ç”¨æ–¹æ³¢
        function playSoundPreview(note, trackId = null) {
            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }
            
            const time = audioContext.currentTime;
            
            // å¦‚æœæ˜¯é¼“è½¨é“ï¼Œæ’­æ”¾é¼“å£°éŸ³
            if (trackId && drumTypes.some(track => track.id === trackId)) {
                playDrumSound(trackId, time, true);
                return;
            }
            
            // éŸ³é«˜é¢„è§ˆä½¿ç”¨æ–¹æ³¢
            const frequency = 440 * Math.pow(2, (note - 69) / 12);
            playSquareSoundPreview(frequency, time);
        }
        
        // æ’­æ”¾æ–¹æ³¢å£°éŸ³é¢„è§ˆ
        function playSquareSoundPreview(frequency, time) {
            // åˆ›å»ºæŒ¯è¡å™¨
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            // ä½¿ç”¨è‡ªå®šä¹‰æ–¹æ³¢å®ç°ï¼ˆä½¿ç”¨bufferï¼‰
            createCustomSquareWave(oscillator, trackSettings.square_a.duty || 0.5);
            
            oscillator.frequency.setValueAtTime(frequency, time);
            
            // è®¾ç½®éŸ³é‡åŒ…ç»œ
            gainNode.gain.setValueAtTime(0, time);
            gainNode.gain.linearRampToValueAtTime(0.3, time + 0.05);
            gainNode.gain.exponentialRampToValueAtTime(0.001, time + 0.3);
            
            // å¼€å§‹å’Œåœæ­¢æŒ¯è¡å™¨
            oscillator.start(time);
            oscillator.stop(time + 0.5);
        }
        
        // åˆ›å»ºè‡ªå®šä¹‰æ–¹æ³¢ï¼ˆä½¿ç”¨bufferå®ç°ï¼‰
        function createCustomSquareWave(oscillator, duty) {
            const real = new Float32Array(256);
            const imag = new Float32Array(256);
            
            // åˆ›å»ºæ–¹æ³¢
            for (let n = 1; n < 256; n++) {
                // æ–¹æ³¢çš„å‚…é‡Œå¶çº§æ•°è¡¨ç¤º
                const harmonic = n;
                const amplitude = (4 / (Math.PI * harmonic)) * Math.sin(Math.PI * harmonic * duty);
                real[n] = amplitude;
                imag[n] = 0;
            }
            
            const customWave = audioContext.createPeriodicWave(real, imag);
            oscillator.setPeriodicWave(customWave);
        }
        
        // åˆ›å»ºä¸‰è§’æ³¢bufferï¼ˆä½¿ç”¨bufferå®ç°ä¸‰è§’æ³¢ï¼‰
        function createTriangleWaveBuffer(frequency, bitcrush = 0) {
            // åˆ›å»ºbufferï¼Œé•¿åº¦ä¸º1ä¸ªå‘¨æœŸ
            const sampleRate = audioContext.sampleRate;
            const cycleLength = Math.floor(sampleRate / frequency);
            const buffer = audioContext.createBuffer(1, cycleLength, sampleRate);
            const data = buffer.getChannelData(0);
            
            // ç”Ÿæˆä¸‰è§’æ³¢
            for (let i = 0; i < cycleLength; i++) {
                // è®¡ç®—ä¸‰è§’æ³¢ä½ç½® (0åˆ°1)
                const t = i / cycleLength;
                let value;
                
                // ä¸‰è§’æ³¢å…¬å¼ï¼šä¸Šå‡ã€ä¸‹é™ã€å†ä¸Šå‡
                if (t < 0.25) {
                    // 0åˆ°1
                    value = t * 4;
                } else if (t < 0.75) {
                    // 1åˆ°-1
                    value = 1 - (t - 0.25) * 4;
                } else {
                    // -1åˆ°0
                    value = -1 + (t - 0.75) * 4;
                }
                
                // åº”ç”¨bitcrushæ•ˆæœï¼ˆæ¨¡æ‹Ÿ8ä½æ¸¸æˆæœºéŸ³è´¨ï¼‰
                if (bitcrush > 0) {
                    // å°†bitcrushå€¼æ˜ å°„åˆ°é‡åŒ–çº§åˆ«ï¼ˆ0.0=æ— æ•ˆæœï¼Œ1.0=æœ€å¤§æ•ˆæœï¼‰
                    const levels = Math.max(2, Math.floor(256 * (1 - bitcrush)));
                    const step = 2 / levels;
                    
                    // é‡åŒ–æ³¢å½¢å€¼
                    value = Math.round(value / step) * step;
                    
                    // ç¡®ä¿å€¼åœ¨èŒƒå›´å†…
                    value = Math.max(-1, Math.min(1, value));
                }
                
                data[i] = value;
            }
            
            return buffer;
        }
        
        // æ’­æ”¾åºåˆ—æ—¶çš„å£°éŸ³
        function playSound(trackId, step = null) {
            // å¦‚æœè½¨é“è¢«é™éŸ³ï¼Œä¸æ’­æ”¾
            if (mutedTracks[trackId]) return;
            
            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }
            
            const time = audioContext.currentTime;
            
            // æ£€æŸ¥æ˜¯å¦æ˜¯éŸ³é«˜è½¨é“
            const isPitchTrack = pitchTracks.some(track => track.id === trackId);
            
            if (isPitchTrack && step !== null) {
                // éŸ³é«˜è½¨é“
                const noteData = blocks[currentBlock].data[trackId];
                if (!noteData.active[step]) return;
                
                const midiNote = noteData.notes[step];
                const frequency = 440 * Math.pow(2, (midiNote - 69) / 12);
                
                playSynthSound(trackId, frequency, time);
                
                // æ›´æ–°è¶£å‘³å¯è§†åŒ–
                updateFunVisualizer(trackId, step);
            } else {
                // é¼“è½¨é“
                playDrumSound(trackId, time, false);
                
                // æ›´æ–°è¶£å‘³å¯è§†åŒ–
                updateFunVisualizer(trackId, currentPatternStep);
            }
            
            // æ›´æ–°æ³¢å½¢å¯è§†åŒ–
            updateWaveform();
        }
        
        // æ’­æ”¾åˆæˆå™¨å£°éŸ³ï¼ˆå¸¦é¢¤éŸ³å’Œbitcrushæ•ˆæœï¼‰
        function playSynthSound(trackId, baseFrequency, time) {
            const settings = trackSettings[trackId];
            
            // ç‰¹æ®Šå¤„ç†ä¸‰è§’æ³¢ï¼šä½¿ç”¨bufferå®ç°
            if (trackId === 'triangle') {
                playTriangleWaveSound(baseFrequency, time, settings);
                return;
            }
            
            // å…¶ä»–è½¨é“ä½¿ç”¨åŸæœ‰çš„å®ç°
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            // è®¾ç½®æŒ¯è¡å™¨ç±»å‹
            if (trackId.startsWith('square')) {
                // æ–¹æ³¢ä½¿ç”¨è‡ªå®šä¹‰æ³¢å½¢
                createCustomSquareWave(oscillator, settings.duty || 0.5);
            } else {
                oscillator.type = trackId === 'sawtooth' ? 'sawtooth' : 'triangle';
            }
            
            // åº”ç”¨é¢¤éŸ³æ•ˆæœï¼ˆå¦‚æœè®¾ç½®ä¸ä¸º0ï¼‰
            if (settings.vibratoSpeed > 0 && settings.vibratoDepth > 0) {
                // åˆ›å»ºé¢¤éŸ³æŒ¯è¡å™¨ï¼ˆä½é¢‘æŒ¯è¡å™¨ï¼‰
                const vibratoOscillator = audioContext.createOscillator();
                const vibratoGain = audioContext.createGain();
                
                // è®¾ç½®é¢¤éŸ³å‚æ•°
                vibratoOscillator.frequency.setValueAtTime(settings.vibratoSpeed, time);
                
                // è®¾ç½®é¢¤éŸ³æ·±åº¦ï¼Œå¹¶åº”ç”¨attackæ—¶é—´
                if (settings.vibratoAttack > 0) {
                    // é¢¤éŸ³æ·±åº¦ä»0å¼€å§‹ï¼Œåœ¨attackæ—¶é—´å†…é€æ¸å¢åŠ åˆ°è®¾å®šå€¼
                    vibratoGain.gain.setValueAtTime(0, time);
                    vibratoGain.gain.linearRampToValueAtTime(settings.vibratoDepth * 5, time + settings.vibratoAttack);
                } else {
                    vibratoGain.gain.setValueAtTime(settings.vibratoDepth * 5, time);
                }
                
                // è¿æ¥é¢¤éŸ³åˆ°ä¸»æŒ¯è¡å™¨é¢‘ç‡
                vibratoOscillator.connect(vibratoGain);
                vibratoGain.connect(oscillator.frequency);
                
                // è®¾ç½®åŸºç¡€é¢‘ç‡
                oscillator.frequency.setValueAtTime(baseFrequency, time);
                
                // å¼€å§‹é¢¤éŸ³æŒ¯è¡å™¨
                vibratoOscillator.start(time);
                vibratoOscillator.stop(time + settings.attack + settings.decay + 0.1);
            } else {
                // æ²¡æœ‰é¢¤éŸ³ï¼Œç›´æ¥è®¾ç½®é¢‘ç‡
                oscillator.frequency.setValueAtTime(baseFrequency, time);
            }
            
            // è®¾ç½®éŸ³é‡åŒ…ç»œ
            gainNode.gain.setValueAtTime(0, time);
            gainNode.gain.linearRampToValueAtTime(settings.volume, time + settings.attack);
            gainNode.gain.exponentialRampToValueAtTime(0.001, time + settings.attack + settings.decay);
            
            // å¼€å§‹å’Œåœæ­¢æŒ¯è¡å™¨
            oscillator.start(time);
            oscillator.stop(time + settings.attack + settings.decay + 0.1);
        }
        
        // æ’­æ”¾ä¸‰è§’æ³¢å£°éŸ³ï¼ˆä½¿ç”¨bufferå®ç°ï¼Œæ”¯æŒé¢¤éŸ³å’Œbitcrushï¼‰
        function playTriangleWaveSound(baseFrequency, time, settings) {
            // åˆ›å»ºbuffer source
            const bufferSource = audioContext.createBufferSource();
            const gainNode = audioContext.createGain();
            
            // åˆ›å»ºä¸‰è§’æ³¢bufferï¼ˆåº”ç”¨bitcrushæ•ˆæœï¼‰
            const buffer = createTriangleWaveBuffer(baseFrequency, settings.bitcrush);
            bufferSource.buffer = buffer;
            bufferSource.loop = true;
            
            bufferSource.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            // åº”ç”¨é¢¤éŸ³æ•ˆæœï¼ˆå¦‚æœè®¾ç½®ä¸ä¸º0ï¼‰
            if (settings.vibratoSpeed > 0 && settings.vibratoDepth > 0) {
                // åˆ›å»ºé¢¤éŸ³æŒ¯è¡å™¨ï¼ˆä½é¢‘æŒ¯è¡å™¨ï¼‰
                const vibratoOscillator = audioContext.createOscillator();
                const vibratoGain = audioContext.createGain();
                
                // è®¾ç½®é¢¤éŸ³å‚æ•°
                vibratoOscillator.frequency.setValueAtTime(settings.vibratoSpeed, time);
                
                // è®¾ç½®é¢¤éŸ³æ·±åº¦ï¼Œå¹¶åº”ç”¨attackæ—¶é—´
                if (settings.vibratoAttack > 0) {
                    // é¢¤éŸ³æ·±åº¦ä»0å¼€å§‹ï¼Œåœ¨attackæ—¶é—´å†…é€æ¸å¢åŠ åˆ°è®¾å®šå€¼
                    vibratoGain.gain.setValueAtTime(0, time);
                    vibratoGain.gain.linearRampToValueAtTime(settings.vibratoDepth * baseFrequency / 2, time + settings.vibratoAttack);
                } else {
                    vibratoGain.gain.setValueAtTime(settings.vibratoDepth * baseFrequency / 2, time);
                }
                
                // åˆ›å»ºconstant sourceç”¨äºåŸºç¡€é¢‘ç‡
                const constantSource = audioContext.createConstantSource();
                constantSource.offset.setValueAtTime(baseFrequency, time);
                
                // è¿æ¥constant sourceå’Œé¢¤éŸ³åˆ°playback rate
                constantSource.connect(bufferSource.detune);
                vibratoOscillator.connect(vibratoGain).connect(bufferSource.detune);
                
                // å¼€å§‹constant sourceå’Œé¢¤éŸ³æŒ¯è¡å™¨
                constantSource.start(time);
                vibratoOscillator.start(time);
                
                // åœæ­¢constant sourceå’Œé¢¤éŸ³æŒ¯è¡å™¨
                constantSource.stop(time + settings.attack + settings.decay + 0.1);
                vibratoOscillator.stop(time + settings.attack + settings.decay + 0.1);
            } else {
                // æ²¡æœ‰é¢¤éŸ³ï¼Œç›´æ¥è®¾ç½®playback rate
                bufferSource.playbackRate.setValueAtTime(1, time);
            }
            
            // è®¾ç½®éŸ³é‡åŒ…ç»œ
            gainNode.gain.setValueAtTime(0, time);
            gainNode.gain.linearRampToValueAtTime(settings.volume, time + settings.attack);
            gainNode.gain.exponentialRampToValueAtTime(0.001, time + settings.attack + settings.decay);
            
            // å¼€å§‹å’Œåœæ­¢buffer source
            bufferSource.start(time);
            bufferSource.stop(time + settings.attack + settings.decay + 0.1);
        }
        
        // æ’­æ”¾é¼“å£°éŸ³
        function playDrumSound(drumType, time, isPreview = false) {
            const settings = trackSettings[drumType];
            
            // åº”ç”¨éŸ³é‡è®¾ç½®ï¼ˆå¦‚æœæ˜¯é¢„è§ˆï¼Œä½¿ç”¨è¾ƒå°éŸ³é‡ï¼‰
            const volume = isPreview ? settings.volume * 0.5 : settings.volume;
            
            switch(drumType) {
                case 'kick':
                    // ä½éŸ³é¼“ï¼šæ­£å¼¦æ³¢æŒ¯è¡å™¨ + é¢‘ç‡è¡°å‡
                    const kickOsc = audioContext.createOscillator();
                    const kickGain = audioContext.createGain();
                    
                    kickOsc.connect(kickGain);
                    kickGain.connect(audioContext.destination);
                    
                    kickOsc.frequency.setValueAtTime(settings.tone, time);
                    kickOsc.frequency.exponentialRampToValueAtTime(0.001, time + settings.decay);
                    
                    kickGain.gain.setValueAtTime(volume, time);
                    kickGain.gain.exponentialRampToValueAtTime(0.001, time + settings.decay);
                    
                    kickOsc.start(time);
                    kickOsc.stop(time + settings.decay + 0.1);
                    break;
                    
                case 'snare':
                    // å†›é¼“ï¼šå™ªå£° + å¸¦é€šæ»¤æ³¢
                    const noiseBuffer = audioContext.createBuffer(1, audioContext.sampleRate * 0.5, audioContext.sampleRate);
                    const noiseOutput = noiseBuffer.getChannelData(0);
                    
                    for (let i = 0; i < noiseOutput.length; i++) {
                        noiseOutput[i] = Math.random() * 2 - 1;
                    }
                    
                    const noiseSource = audioContext.createBufferSource();
                    noiseSource.buffer = noiseBuffer;
                    
                    const noiseFilter = audioContext.createBiquadFilter();
                    noiseFilter.type = 'bandpass';
                    noiseFilter.frequency.value = settings.tone;
                    
                    const noiseGain = audioContext.createGain();
                    noiseGain.gain.setValueAtTime(settings.noise * volume, time);
                    noiseGain.gain.exponentialRampToValueAtTime(0.01, time + settings.decay);
                    
                    noiseSource.connect(noiseFilter);
                    noiseFilter.connect(noiseGain);
                    noiseGain.connect(audioContext.destination);
                    
                    noiseSource.start(time);
                    
                    // æ·»åŠ ä¸€ä¸ªçŸ­æš‚çš„éŸ³è°ƒ
                    const snareOsc = audioContext.createOscillator();
                    const snareGain = audioContext.createGain();
                    
                    snareOsc.frequency.setValueAtTime(settings.tone, time);
                    snareGain.gain.setValueAtTime(0.5 * volume, time);
                    snareGain.gain.exponentialRampToValueAtTime(0.01, time + settings.decay / 2);
                    
                    snareOsc.connect(snareGain);
                    snareGain.connect(audioContext.destination);
                    
                    snareOsc.start(time);
                    snareOsc.stop(time + settings.decay / 2);
                    break;
                    
                case 'hihat':
                    // è¸©é•²ï¼šé«˜é¢‘å™ªå£° + å¿«é€Ÿè¡°å‡
                    const hihatBuffer = audioContext.createBuffer(1, audioContext.sampleRate * 0.1, audioContext.sampleRate);
                    const hihatOutput = hihatBuffer.getChannelData(0);
                    
                    for (let i = 0; i < hihatOutput.length; i++) {
                        hihatOutput[i] = Math.random() * 2 - 1;
                    }
                    
                    const hihatSource = audioContext.createBufferSource();
                    hihatSource.buffer = hihatBuffer;
                    
                    const hihatFilter = audioContext.createBiquadFilter();
                    hihatFilter.type = 'highpass';
                    hihatFilter.frequency.value = settings.tone;
                    
                    const hihatGain = audioContext.createGain();
                    hihatGain.gain.setValueAtTime(0.7 * volume, time);
                    hihatGain.gain.exponentialRampToValueAtTime(0.01, time + settings.decay);
                    
                    hihatSource.connect(hihatFilter);
                    hihatFilter.connect(hihatGain);
                    hihatGain.connect(audioContext.destination);
                    
                    hihatSource.start(time);
                    break;
                    
                case 'openhat':
                    // å¼€é•²ï¼šå™ªå£° + è¾ƒé•¿è¡°å‡
                    const openhatBuffer = audioContext.createBuffer(1, audioContext.sampleRate * 0.3, audioContext.sampleRate);
                    const openhatOutput = openhatBuffer.getChannelData(0);
                    
                    for (let i = 0; i < openhatOutput.length; i++) {
                        openhatOutput[i] = Math.random() * 2 - 1;
                    }
                    
                    const openhatSource = audioContext.createBufferSource();
                    openhatSource.buffer = openhatBuffer;
                    
                    const openhatFilter = audioContext.createBiquadFilter();
                    openhatFilter.type = 'highpass';
                    openhatFilter.frequency.value = settings.tone;
                    
                    const openhatGain = audioContext.createGain();
                    openhatGain.gain.setValueAtTime(0.5 * volume, time);
                    openhatGain.gain.exponentialRampToValueAtTime(0.01, time + settings.decay);
                    
                    openhatSource.connect(openhatFilter);
                    openhatFilter.connect(openhatGain);
                    openhatGain.connect(audioContext.destination);
                    
                    openhatSource.start(time);
                    break;
                    
                case 'clap':
                    // æ‹æ‰‹ï¼šå¤šä¸ªçŸ­å™ªå£°è„‰å†²
                    for (let i = 0; i < settings.count; i++) {
                        const clapBuffer = audioContext.createBuffer(1, audioContext.sampleRate * 0.05, audioContext.sampleRate);
                        const clapOutput = clapBuffer.getChannelData(0);
                        
                        for (let j = 0; j < clapOutput.length; j++) {
                            clapOutput[j] = Math.random() * 2 - 1;
                        }
                        
                        const clapSource = audioContext.createBufferSource();
                        clapSource.buffer = clapBuffer;
                        
                        const clapGain = audioContext.createGain();
                        clapGain.gain.setValueAtTime((0.8 - (i * 0.2)) * volume, time + (i * settings.delay));
                        clapGain.gain.exponentialRampToValueAtTime(0.01, time + (i * settings.delay) + settings.decay);
                        
                        clapSource.connect(clapGain);
                        clapGain.connect(audioContext.destination);
                        
                        clapSource.start(time + (i * settings.delay));
                    }
                    break;
            }
        }
        
        // æ¸²æŸ“é«˜çº§è®¾ç½®ç•Œé¢ï¼ˆåŒ…å«é¢¤éŸ³å’Œbitcrushå‚æ•°ï¼‰
        function renderAdvancedSettings() {
            settingsContent.innerHTML = '';
            
            allTracks.forEach(track => {
                const settingGroup = document.createElement('div');
                settingGroup.className = 'setting-group';
                
                const title = document.createElement('h3');
                title.textContent = track.name;
                settingGroup.appendChild(title);
                
                const settings = trackSettings[track.id];
                for (const [key, value] of Object.entries(settings)) {
                    const settingRow = document.createElement('div');
                    settingRow.className = 'setting-row';
                    
                    const label = document.createElement('div');
                    label.className = 'setting-label';
                    
                    // ä¸ºå‚æ•°ä½¿ç”¨æ›´å‹å¥½çš„æ ‡ç­¾
                    if (key === 'vibratoSpeed') {
                        label.textContent = 'VIBRATO SPD';
                    } else if (key === 'vibratoDepth') {
                        label.textContent = 'VIBRATO DPTH';
                    } else if (key === 'vibratoAttack') {
                        label.textContent = 'VIBRATO ATK';
                    } else if (key === 'bitcrush') {
                        label.textContent = 'BITCRUSH';
                    } else {
                        label.textContent = key.toUpperCase();
                    }
                    
                    const valueDisplay = document.createElement('div');
                    valueDisplay.className = 'setting-value';
                    valueDisplay.id = `setting-${track.id}-${key}`;
                    
                    // æ ¹æ®å‚æ•°ç±»å‹æ ¼å¼åŒ–æ˜¾ç¤ºå€¼
                    if (key === 'tone' || key === 'count') {
                        valueDisplay.textContent = Math.round(value);
                    } else if (key === 'volume' || key === 'duty' || key === 'noise' || key === 'vibratoSpeed' || key === 'vibratoDepth' || key === 'vibratoAttack' || key === 'bitcrush') {
                        valueDisplay.textContent = value.toFixed(2);
                    } else {
                        valueDisplay.textContent = value.toFixed(2);
                    }
                    
                    const slider = document.createElement('input');
                    slider.type = 'range';
                    
                    // æ ¹æ®å‚æ•°è®¾ç½®æ»‘å—å±æ€§
                    if (key === 'tone') {
                        slider.className = 'setting-slider tone';
                        slider.min = '50';
                        slider.max = '10000';
                        slider.step = '10';
                        slider.value = value;
                    } else if (key === 'count') {
                        slider.className = 'setting-slider count';
                        slider.min = '1';
                        slider.max = '5';
                        slider.step = '1';
                        slider.value = value;
                    } else if (key === 'delay') {
                        slider.className = 'setting-slider delay';
                        slider.min = '0.01';
                        slider.max = '0.1';
                        slider.step = '0.01';
                        slider.value = value;
                    } else if (key === 'duty') {
                        slider.className = 'setting-slider duty';
                        slider.min = '0.1';
                        slider.max = '0.9';
                        slider.step = '0.05';
                        slider.value = value;
                    } else if (key === 'volume') {
                        slider.className = 'setting-slider volume';
                        slider.min = '0';
                        slider.max = '2';
                        slider.step = '0.05';
                        slider.value = value;
                    } else if (key === 'noise') {
                        slider.className = 'setting-slider noise';
                        slider.min = '0';
                        slider.max = '1';
                        slider.step = '0.05';
                        slider.value = value;
                    } else if (key === 'vibratoSpeed') {
                        slider.className = 'setting-slider vibrato-speed';
                        slider.min = '0';
                        slider.max = '20';
                        slider.step = '0.1';
                        slider.value = value;
                    } else if (key === 'vibratoDepth') {
                        slider.className = 'setting-slider vibrato-depth';
                        slider.min = '0';
                        slider.max = '2';
                        slider.step = '0.01';
                        slider.value = value;
                    } else if (key === 'vibratoAttack') {
                        slider.className = 'setting-slider vibrato-attack';
                        slider.min = '0';
                        slider.max = '1';
                        slider.step = '0.01';
                        slider.value = value;
                    } else if (key === 'bitcrush') {
                        slider.className = 'setting-slider bitcrush';
                        slider.min = '0';
                        slider.max = '1';
                        slider.step = '0.01';
                        slider.value = value;
                    } else {
                        slider.className = `setting-slider ${key}`;
                        slider.min = '0';
                        slider.max = '1';
                        slider.step = '0.01';
                        slider.value = value;
                    }
                    
                    slider.addEventListener('input', function() {
                        const newValue = parseFloat(this.value);
                        settings[key] = newValue;
                        
                        // æ›´æ–°å€¼æ˜¾ç¤º
                        if (key === 'tone' || key === 'count') {
                            valueDisplay.textContent = Math.round(newValue);
                        } else {
                            valueDisplay.textContent = newValue.toFixed(2);
                        }
                    });
                    
                    settingRow.appendChild(label);
                    settingRow.appendChild(slider);
                    settingRow.appendChild(valueDisplay);
                    settingGroup.appendChild(settingRow);
                }
                
                settingsContent.appendChild(settingGroup);
            });
        }
        
        // æ¸²æŸ“é’¢ç´é”®ç›˜ï¼ˆæ‰€æœ‰ç´é”®æ”¹ä¸ºç›¸åŒå¤§å°çš„çŸ©å½¢ï¼‰
        function renderPianoKeyboard() {
            pianoKeyboard.innerHTML = '';
            
            // è®¡ç®—å½“å‰å…«åº¦çš„éŸ³ç¬¦èŒƒå›´
            const startNote = 12 * (currentOctave + 1); // C0 = 12, æ‰€ä»¥C4 = 60
            const endNote = startNote + 11; // æ˜¾ç¤ºä¸€ä¸ªå…«åº¦åŠ ä¸€ä¸ªéŸ³ç¬¦ï¼ˆ12ä¸ªé”®ï¼‰
            
            // åˆ›å»ºç´é”®
            for (let note = startNote; note <= endNote; note++) {
                const noteName = midiToNote(note);
                const isBlackKey = noteName.includes('#');
                
                const key = document.createElement('div');
                key.className = `piano-key ${isBlackKey ? 'black-key' : 'white-key'} ${selectedNote === note ? 'active' : ''}`;
                key.dataset.note = note;
                key.dataset.name = noteName;
                
                const label = document.createElement('div');
                label.className = 'key-label';
                label.textContent = noteName;
                key.appendChild(label);
                
                key.addEventListener('click', () => {
                    // æ›´æ–°é€‰ä¸­çš„éŸ³ç¬¦
                    selectedNote = note;
                    
                    // æ›´æ–°é”®ç›˜æ˜¾ç¤º
                    document.querySelectorAll('.piano-key').forEach(k => {
                        k.classList.remove('active');
                    });
                    key.classList.add('active');
                    
                    // æ’­æ”¾é¢„è§ˆå£°éŸ³ï¼ˆä½¿ç”¨æ–¹æ³¢ï¼‰
                    playSoundPreview(note);
                });
                
                pianoKeyboard.appendChild(key);
            }
        }
        
        // é™ä½å…«åº¦
        function decreaseOctave() {
            if (currentOctave > 1) {
                currentOctave--;
                currentOctaveDisplay.textContent = currentOctave;
                renderPianoKeyboard();
                
                // è°ƒæ•´é€‰ä¸­çš„éŸ³ç¬¦åˆ°æ–°å…«åº¦
                const noteName = midiToNote(selectedNote);
                const newNoteName = noteName.replace(/\d+$/, currentOctave);
                const newMidiNote = noteToMidi(newNoteName);
                if (newMidiNote !== null) {
                    selectedNote = newMidiNote;
                    renderPianoKeyboard();
                }
            }
        }
        
        // æé«˜å…«åº¦
        function increaseOctave() {
            if (currentOctave < 6) {
                currentOctave++;
                currentOctaveDisplay.textContent = currentOctave;
                renderPianoKeyboard();
                
                // è°ƒæ•´é€‰ä¸­çš„éŸ³ç¬¦åˆ°æ–°å…«åº¦
                const noteName = midiToNote(selectedNote);
                const newNoteName = noteName.replace(/\d+$/, currentOctave);
                const newMidiNote = noteToMidi(newNoteName);
                if (newMidiNote !== null) {
                    selectedNote = newMidiNote;
                    renderPianoKeyboard();
                }
            }
        }
        
        // é™ä½åŠéŸ³
        function decreaseSemitone() {
            if (selectedNote > 0) {
                selectedNote--;
                renderPianoKeyboard();
                playSoundPreview(selectedNote);
            }
        }
        
        // å‡é«˜åŠéŸ³
        function increaseSemitone() {
            if (selectedNote < 127) {
                selectedNote++;
                renderPianoKeyboard();
                playSoundPreview(selectedNote);
            }
        }
        
        // æ’­æ”¾åºåˆ—
        function playSequence() {
            if (!isPlaying) return;
            
            // æ¸…é™¤å½“å‰æ­¥è¿›çš„è§†è§‰åé¦ˆ
            const allSteps = document.querySelectorAll('.step-cell');
            allSteps.forEach(step => step.classList.remove('current'));
            
            const captionSteps = document.querySelectorAll('.caption-step-cell');
            captionSteps.forEach(step => step.classList.remove('current'));
            
            // æ›´æ–°å½“å‰æ­¥è¿›æŒ‡ç¤ºå™¨
            const currentSteps = document.querySelectorAll(`.step-cell[data-step="${currentPatternStep}"]`);
            currentSteps.forEach(step => step.classList.add('current'));
            
            // æ›´æ–°å­—å¹•éŸ³åºå™¨å½“å‰æ­¥è¿›æŒ‡ç¤ºå™¨
            const currentCaptionStep = document.querySelector(`.caption-step-cell[data-step="${currentPatternStep}"]`);
            if (currentCaptionStep) {
                currentCaptionStep.classList.add('current');
            }
            
            // æ’­æ”¾å½“å‰æ­¥è¿›çš„å£°éŸ³
            allTracks.forEach(track => {
                const trackData = blocks[currentBlock].data[track.id];
                
                if (pitchTracks.includes(track)) {
                    // éŸ³é«˜è½¨é“
                    if (trackData && trackData.active[currentPatternStep]) {
                        playSound(track.id, currentPatternStep);
                    }
                } else {
                    // é¼“è½¨é“
                    if (trackData && trackData[currentPatternStep]) {
                        playSound(track.id);
                    }
                }
            });
            
            // æ›´æ–°å­—å¹•æ˜¾ç¤ºï¼ˆåªåœ¨æœ‰å­—å¹•æ—¶æ‰æ›´æ–°ï¼Œä¸”å­—å¹•éŸ³åºå™¨æ‰“å¼€æ—¶ï¼‰
            const currentCaption = blocks[currentBlock].caption[currentPatternStep];
            if (currentCaption !== undefined && currentCaption !== "") {
                showCaption(currentCaption, false);
            }
            // å¦‚æœæ²¡æœ‰å­—å¹•ï¼Œä¿æŒå½“å‰æ˜¾ç¤ºçš„å­—å¹•ä¸å˜ï¼ˆä¸éšè—ï¼‰
            
            // æ›´æ–°èŠ‚æ‹æŒ‡ç¤ºå™¨ä½ç½®
            const stepWidth = 100 / stepCount;
            beatIndicator.style.left = `${currentPatternStep * stepWidth}%`;
            
            // å‰è¿›åˆ°ä¸‹ä¸€æ­¥
            currentPatternStep++;
            currentStep++;
            
            // æ£€æŸ¥æ˜¯å¦åˆ°è¾¾å½“å‰patternçš„æœ«å°¾
            if (currentPatternStep >= stepCount) {
                currentPatternStep = 0;
                
                // å¦‚æœä¸æ˜¯å¾ªç¯å½“å‰patternï¼Œç§»åŠ¨åˆ°ä¸‹ä¸€ä¸ªpattern
                if (!loopCurrentPattern) {
                    // ç§»åŠ¨åˆ°ä¸‹ä¸€ä¸ªblock
                    const nextBlock = (currentBlock + 1) % blocks.length;
                    setCurrentBlock(nextBlock);
                }
            }
            
            // è®¡ç®—ä¸‹ä¸€æ­¥çš„æ—¶é—´é—´éš”ï¼ˆåŸºäºBPMï¼‰
            const stepDuration = 60 / bpm / 4; // 16åˆ†éŸ³ç¬¦çš„æŒç»­æ—¶é—´
            
            // è®¾ç½®ä¸‹ä¸€æ­¥çš„å®šæ—¶å™¨
            timerId = setTimeout(playSequence, stepDuration * 1000);
        }
        
        // å¼€å§‹æ’­æ”¾
        function startPlayback() {
            if (isPlaying) return;
            
            isPlaying = true;
            playBtn.textContent = "â¸ PAUSE";
            
            // å¦‚æœéŸ³é¢‘ä¸Šä¸‹æ–‡å¤„äºæš‚åœçŠ¶æ€ï¼Œæ¢å¤å®ƒ
            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }
            
            // å¼€å§‹æ’­æ”¾åºåˆ—
            playSequence();
        }
        
        // æš‚åœæ’­æ”¾ï¼ˆä¸é‡ç½®è¿›åº¦ï¼‰
        function pausePlayback() {
            if (!isPlaying) return;
            
            isPlaying = false;
            playBtn.textContent = "â–¶ PLAY";
            
            if (timerId) {
                clearTimeout(timerId);
                timerId = null;
            }
            
            // ä¸ç§»é™¤å½“å‰æ­¥è¿›æŒ‡ç¤ºï¼Œä¿ç•™å½“å‰çŠ¶æ€
            // ä¸é‡ç½®èŠ‚æ‹æŒ‡ç¤ºå™¨ä½ç½®
            // ä¸é‡ç½®currentPatternStepå’ŒcurrentStep
        }
        
        // åœæ­¢æ’­æ”¾ï¼ˆé‡ç½®è¿›åº¦ï¼‰
        function stopPlayback() {
            isPlaying = false;
            playBtn.textContent = "â–¶ PLAY";
            
            if (timerId) {
                clearTimeout(timerId);
                timerId = null;
            }
            
            // ç§»é™¤å½“å‰æ­¥è¿›æŒ‡ç¤º
            const allSteps = document.querySelectorAll('.step-cell');
            allSteps.forEach(step => step.classList.remove('current'));
            
            const captionSteps = document.querySelectorAll('.caption-step-cell');
            captionSteps.forEach(step => step.classList.remove('current'));
            
            // é‡ç½®èŠ‚æ‹æŒ‡ç¤ºå™¨
            beatIndicator.style.left = "0%";
            currentPatternStep = 0;
            currentStep = 0;
            
            // æ¸…é™¤å­—å¹•æ˜¾ç¤º
            clearCaptionDisplay();
            
            // å›åˆ°ç¬¬ä¸€ä¸ªpattern
            setCurrentBlock(0);
        }
        
        // åˆ‡æ¢å¾ªç¯æ¨¡å¼
        function toggleLoopMode() {
            loopCurrentPattern = !loopCurrentPattern;
            loopBtn.textContent = loopCurrentPattern ? "LOOP ON" : "LOOP";
            loopBtn.classList.toggle('active', loopCurrentPattern);
        }
        
        // åˆ‡æ¢å­—å¹•éŸ³åºå™¨æ˜¾ç¤º
        function toggleCaptionSequencer() {
            isCaptionVisible = !isCaptionVisible;
            captionSequencer.classList.toggle('active', isCaptionVisible);
            captionBtn.classList.toggle('active', isCaptionVisible);
            
            // å¦‚æœéšè—å­—å¹•éŸ³åºå™¨ï¼Œä¹Ÿéšè—å­—å¹•æ˜¾ç¤º
            if (!isCaptionVisible) {
                clearCaptionDisplay();
            }
        }
        
        // åˆ‡æ¢å¸®åŠ©çª—å£æ˜¾ç¤º
        function toggleHelpWindow() {
            isHelpVisible = !isHelpVisible;
            helpWindow.classList.toggle('active', isHelpVisible);
            overlay.classList.toggle('active', isHelpVisible);
        }
        
        // æ–°å»ºå·¥ç¨‹ï¼ˆå›åˆ°é»˜è®¤çŠ¶æ€ï¼‰
        function newProject() {
            if (confirm('Are you sure you want to create a new project? All unsaved changes will be lost.')) {
                // é‡ç½®æ‰€æœ‰çŠ¶æ€
                isPlaying = false;
                loopCurrentPattern = false;
                currentStep = 0;
                currentPatternStep = 0;
                bpm = 120;
                bpmSlider.value = bpm;
                bpmValue.textContent = bpm;
                timeSignature = 4;
                currentOctave = 4;
                currentOctaveDisplay.textContent = currentOctave;
                selectedNote = 60;
                mutedTracks = {};
                currentCaption = "";
                clearCaptionDisplay();
                isCaptionVisible = false;
                captionSequencer.classList.remove('active');
                captionBtn.classList.remove('active');
                isHelpVisible = false;
                helpWindow.classList.remove('active');
                overlay.classList.remove('active');
                
                // é‡ç½®æ‹å·æŒ‰é’®
                timeSignatureBtns.forEach(btn => {
                    btn.classList.toggle('active', parseInt(btn.dataset.time) === timeSignature);
                });
                
                // é‡ç½®è½¨é“è®¾ç½®
                trackSettings = JSON.parse(JSON.stringify(defaultTrackSettings));
                
                // é‡æ–°åˆå§‹åŒ–blocks
                initBlocks();
                
                // é‡æ–°æ¸²æŸ“é«˜çº§è®¾ç½®
                renderAdvancedSettings();
                
                // é‡æ–°æ¸²æŸ“é’¢ç´é”®ç›˜
                renderPianoKeyboard();
                
                // åœæ­¢æ’­æ”¾
                stopPlayback();
                
                alert('New project created!');
            }
        }
        
        // æ¸…é™¤å½“å‰pattern
        function clearCurrentPattern() {
            allTracks.forEach(track => {
                const trackData = blocks[currentBlock].data[track.id];
                
                if (pitchTracks.includes(track)) {
                    // éŸ³é«˜è½¨é“
                    if (trackData) {
                        trackData.active.fill(false);
                        trackData.notes.fill(track.defaultNote);
                    }
                } else {
                    // é¼“è½¨é“
                    if (trackData) {
                        trackData.fill(false);
                    }
                }
            });
            
            // æ¸…é™¤å­—å¹•
            blocks[currentBlock].caption.fill("");
            
            renderSequencerGrid();
            renderCaptionSequencer();
        }
        
        // åˆ‡æ¢å…¨å±æ¨¡å¼
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => {
                    console.log(`Error attempting to enable fullscreen: ${err.message}`);
                });
                fullscreenBtn.textContent = "EXIT FULLSCREEN";
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                    fullscreenBtn.textContent = "FULLSCREEN";
                }
            }
        }
        
        // ç›‘å¬å…¨å±å˜åŒ–
        document.addEventListener('fullscreenchange', () => {
            if (!document.fullscreenElement) {
                fullscreenBtn.textContent = "FULLSCREEN";
            }
        });
        
        // å¯¼å‡ºä¸ºæ­Œæ›²æ–‡ä»¶
        function exportSong() {
            // æ£€æŸ¥æ˜¯å¦æœ‰å­—å¹•æ•°æ®
            let hasCaptionData = false;
            blocks.forEach(block => {
                if (block.caption && block.caption.some(caption => caption && caption.trim() !== '')) {
                    hasCaptionData = true;
                }
            });
            
            const exportData = {
                version: "1.3", // æ›´æ–°ç‰ˆæœ¬å·ä»¥æ”¯æŒä¸‰è§’æ³¢bitcrushå‚æ•°
                bpm: bpm,
                timeSignature: timeSignature,
                loopMode: loopCurrentPattern,
                mutedTracks: mutedTracks,
                trackSettings: trackSettings,
                selectedNote: selectedNote,
                currentOctave: currentOctave,
                blocks: blocks.map(block => {
                    const blockExport = {
                        name: block.name,
                        data: {}
                    };
                    
                    allTracks.forEach(track => {
                        blockExport.data[track.id] = block.data[track.id];
                    });
                    
                    // åªæœ‰åœ¨æœ‰å­—å¹•æ•°æ®æ—¶æ‰åŒ…å«captionå­—æ®µ
                    if (hasCaptionData) {
                        blockExport.caption = block.caption;
                    }
                    
                    return blockExport;
                })
            };
            
            // åˆ›å»ºJSONå­—ç¬¦ä¸²
            const songData = JSON.stringify(exportData, null, 2);
            
            // åˆ›å»ºBlobå¯¹è±¡
            const blob = new Blob([songData], { type: 'application/json' });
            
            // åˆ›å»ºä¸‹è½½é“¾æ¥
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'untitled.song';
            
            // è§¦å‘ä¸‹è½½
            document.body.appendChild(a);
            a.click();
            
            // æ¸…ç†
            setTimeout(() => {
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }, 100);
        }
        
        // å¯¼å…¥æ­Œæ›²æ–‡ä»¶
        function importSong(file) {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const importData = JSON.parse(e.target.result);
                    
                    // å¤„ç†å…¼å®¹æ€§ï¼šå¦‚æœåªæœ‰squareè½¨é“ï¼Œå°†æ•°æ®è½¬ç§»åˆ°square_a
                    if (importData.trackSettings && importData.trackSettings.square && !importData.trackSettings.square_a) {
                        importData.trackSettings.square_a = { ...importData.trackSettings.square };
                        delete importData.trackSettings.square;
                    }
                    
                    // å¤„ç†blocksä¸­çš„æ•°æ®
                    if (importData.blocks) {
                        importData.blocks.forEach(block => {
                            if (block.data) {
                                // å¦‚æœåªæœ‰squareè½¨é“æ•°æ®ï¼Œè½¬ç§»åˆ°square_a
                                if (block.data.square && !block.data.square_a) {
                                    block.data.square_a = block.data.square;
                                    delete block.data.square;
                                }
                            }
                        });
                    }
                    
                    // ä½¿ç”¨é»˜è®¤å€¼å¢å¼ºå…¼å®¹æ€§
                    const enhancedData = enhanceImportData(importData);
                    
                    // æ›´æ–°BPM
                    bpm = enhancedData.bpm;
                    bpmSlider.value = bpm;
                    bpmValue.textContent = bpm;
                    
                    // æ›´æ–°æ‹å·
                    timeSignature = enhancedData.timeSignature;
                    timeSignatureBtns.forEach(btn => {
                        btn.classList.toggle('active', parseInt(btn.dataset.time) === timeSignature);
                    });
                    updateStepCount();
                    
                    // æ›´æ–°å¾ªç¯æ¨¡å¼
                    if (enhancedData.loopMode !== undefined) {
                        loopCurrentPattern = enhancedData.loopMode;
                        loopBtn.textContent = loopCurrentPattern ? "LOOP ON" : "LOOP";
                        loopBtn.classList.toggle('active', loopCurrentPattern);
                    }
                    
                    // æ›´æ–°é™éŸ³è½¨é“
                    if (enhancedData.mutedTracks) {
                        mutedTracks = enhancedData.mutedTracks;
                    }
                    
                    // æ›´æ–°è½¨é“è®¾ç½®
                    if (enhancedData.trackSettings) {
                        // åˆå¹¶è½¨é“è®¾ç½®ï¼Œç¼ºå¤±çš„å‚æ•°ä½¿ç”¨é»˜è®¤å€¼
                        allTracks.forEach(track => {
                            if (enhancedData.trackSettings[track.id]) {
                                // åˆå¹¶ç°æœ‰è®¾ç½®
                                trackSettings[track.id] = {
                                    ...defaultTrackSettings[track.id],
                                    ...enhancedData.trackSettings[track.id]
                                };
                            }
                        });
                        renderAdvancedSettings();
                    }
                    
                    // æ›´æ–°é€‰ä¸­çš„éŸ³ç¬¦å’Œå…«åº¦
                    if (enhancedData.selectedNote) {
                        selectedNote = enhancedData.selectedNote;
                    }
                    
                    if (enhancedData.currentOctave) {
                        currentOctave = enhancedData.currentOctave;
                        currentOctaveDisplay.textContent = currentOctave;
                    }
                    
                    // æ›´æ–°blocks
                    if (enhancedData.blocks && enhancedData.blocks.length > 0) {
                        blocks = enhancedData.blocks.map((block, index) => {
                            // ç¡®ä¿æ¯ä¸ªè½¨é“çš„æ•°æ®ç»“æ„æ­£ç¡®
                            const enhancedBlockData = {
                                id: index,
                                name: block.name || `Pattern ${index + 1}`,
                                data: {},
                                caption: block.caption || new Array(stepCount).fill("")
                            };
                            
                            allTracks.forEach(track => {
                                if (block.data && block.data[track.id]) {
                                    // å¦‚æœå¯¼å…¥çš„æ•°æ®ä¸­æœ‰è¿™ä¸ªè½¨é“çš„æ•°æ®ï¼Œä½¿ç”¨å®ƒ
                                    enhancedBlockData.data[track.id] = block.data[track.id];
                                } else {
                                    // å¦åˆ™åˆ›å»ºé»˜è®¤æ•°æ®
                                    if (pitchTracks.includes(track)) {
                                        enhancedBlockData.data[track.id] = {
                                            active: new Array(stepCount).fill(false),
                                            notes: new Array(stepCount).fill(track.defaultNote)
                                        };
                                    } else {
                                        enhancedBlockData.data[track.id] = new Array(stepCount).fill(false);
                                    }
                                }
                            });
                            
                            return enhancedBlockData;
                        });
                    } else {
                        // å¦‚æœæ²¡æœ‰blocksæ•°æ®ï¼Œåˆ›å»ºä¸€ä¸ªé»˜è®¤block
                        initBlocks();
                    }
                    
                    // è®¾ç½®å½“å‰blockä¸ºç¬¬ä¸€ä¸ª
                    setCurrentBlock(0);
                    
                    // é‡æ–°æ¸²æŸ“é’¢ç´é”®ç›˜
                    renderPianoKeyboard();
                    
                    // é‡æ–°æ¸²æŸ“å­—å¹•éŸ³åºå™¨
                    renderCaptionSequencer();
                    
                    alert('Song imported successfully!');
                } catch (error) {
                    alert(`Import failed: ${error.message}`);
                }
            };
            
            reader.onerror = function() {
                alert('Error reading file');
            };
            
            reader.readAsText(file);
        }
        
        // å¢å¼ºå¯¼å…¥æ•°æ®ï¼Œä½¿ç”¨é»˜è®¤å€¼å¡«å……ç¼ºå¤±çš„å‚æ•°
        function enhanceImportData(importData) {
            const enhancedData = { ...importData };
            
            // ç¡®ä¿å¿…éœ€å­—æ®µå­˜åœ¨
            if (enhancedData.bpm === undefined) enhancedData.bpm = 120;
            if (enhancedData.timeSignature === undefined) enhancedData.timeSignature = 4;
            if (enhancedData.loopMode === undefined) enhancedData.loopMode = false;
            if (enhancedData.mutedTracks === undefined) enhancedData.mutedTracks = {};
            if (enhancedData.selectedNote === undefined) enhancedData.selectedNote = 60;
            if (enhancedData.currentOctave === undefined) enhancedData.currentOctave = 4;
            
            // ç¡®ä¿trackSettingså­˜åœ¨å¹¶è¡¥å…¨ç¼ºå¤±çš„è½¨é“
            if (enhancedData.trackSettings === undefined) {
                enhancedData.trackSettings = JSON.parse(JSON.stringify(defaultTrackSettings));
            } else {
                // è¡¥å…¨ç¼ºå¤±çš„è½¨é“è®¾ç½®
                allTracks.forEach(track => {
                    if (!enhancedData.trackSettings[track.id]) {
                        enhancedData.trackSettings[track.id] = { ...defaultTrackSettings[track.id] };
                    } else {
                        // è¡¥å…¨è½¨é“å†…ç¼ºå¤±çš„å‚æ•°ï¼ˆåŒ…æ‹¬é¢¤éŸ³å‚æ•°å’Œbitcrushå‚æ•°ï¼‰
                        Object.keys(defaultTrackSettings[track.id]).forEach(key => {
                            if (enhancedData.trackSettings[track.id][key] === undefined) {
                                enhancedData.trackSettings[track.id][key] = defaultTrackSettings[track.id][key];
                            }
                        });
                    }
                });
            }
            
            // ç¡®ä¿blockså­˜åœ¨
            if (enhancedData.blocks === undefined) {
                enhancedData.blocks = [];
            }
            
            return enhancedData;
        }
        
        // æ·»åŠ é»˜è®¤patternç”¨äºæ¼”ç¤º
        function addDefaultPattern() {
            setTimeout(() => {
                const kickPattern = [1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0];
                const snarePattern = [0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0];
                const hihatPattern = [1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0];
                
                // åº”ç”¨åˆ°ç¬¬ä¸€ä¸ªblock
                blocks[0].data.kick = [...kickPattern];
                blocks[0].data.snare = [...snarePattern];
                blocks[0].data.hihat = [...hihatPattern];
                
                // æ·»åŠ ä¸€äº›éŸ³é«˜è½¨é“æ•°æ®
                const trianglePattern = [1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0];
                const triangleNotes = [60,60,60,60,60,60,60,60,60,60,60,60,60,60,60,60];
                triangleNotes[0] = 60;
                triangleNotes[4] = 64;
                triangleNotes[8] = 67;
                triangleNotes[12] = 64;
                
                blocks[0].data.triangle = {
                    active: [...trianglePattern],
                    notes: [...triangleNotes]
                };
                
                // æŒ‰ç…§è¦æ±‚ï¼Œé»˜è®¤å·¥ç¨‹ä¸åŒ…å«ä»»ä½•å­—å¹•
                // blocks[0].caption[0] = "Hello!";
                
                // æ¸²æŸ“æ›´æ–°
                renderSequencerGrid();
                renderCaptionSequencer();
            }, 500);
        }
        
        // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
        function setupEventListeners() {
            playBtn.addEventListener('click', () => {
                if (isPlaying) {
                    pausePlayback(); // æš‚åœæ’­æ”¾ï¼Œä¸é‡ç½®è¿›åº¦
                } else {
                    startPlayback();
                }
            });
            
            loopBtn.addEventListener('click', toggleLoopMode);
            
            stopBtn.addEventListener('click', stopPlayback);
            
            newBtn.addEventListener('click', newProject);
            
            clearBtn.addEventListener('click', clearCurrentPattern);
            
            advanceBtn.addEventListener('click', () => {
                advanceSettings.classList.toggle('active');
                advanceBtn.classList.toggle('active');
                advanceBtn.textContent = advanceSettings.classList.contains('active') ? 'HIDE' : 'ADVANCE';
            });
            
            captionBtn.addEventListener('click', toggleCaptionSequencer);
            
            helpBtn.addEventListener('click', toggleHelpWindow);
            
            helpClose.addEventListener('click', toggleHelpWindow);
            
            overlay.addEventListener('click', toggleHelpWindow);
            
            fullscreenBtn.addEventListener('click', toggleFullscreen);
            
            // ä¿®æ”¹BPMæ»‘å—äº‹ä»¶ï¼šæ›´æ”¹BPMæ—¶ä¸æ›´æ”¹æ’­æ”¾è¿›åº¦
            bpmSlider.addEventListener('input', function() {
                bpm = parseInt(this.value);
                bpmValue.textContent = bpm;
                // æ³¨æ„ï¼šä¸å†é‡æ–°å¯åŠ¨æ’­æ”¾ï¼Œåªæ›´æ–°BPMå€¼
            });
            
            // æ‹å·æŒ‰é’®
            timeSignatureBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const newTimeSignature = parseInt(this.dataset.time);
                    if (timeSignature !== newTimeSignature) {
                        timeSignature = newTimeSignature;
                        
                        // æ›´æ–°æŒ‰é’®çŠ¶æ€
                        timeSignatureBtns.forEach(b => b.classList.remove('active'));
                        this.classList.add('active');
                        
                        // æ›´æ–°æ­¥æ•°
                        updateStepCount();
                        
                        // å¦‚æœæ­£åœ¨æ’­æ”¾ï¼Œé‡æ–°å¯åŠ¨
                        if (isPlaying) {
                            stopPlayback();
                            startPlayback();
                        }
                    }
                });
            });
            
            // Blockæ§åˆ¶æŒ‰é’®
            addBlockBtn.addEventListener('click', addNewBlock);
            removeBlockBtn.addEventListener('click', removeCurrentBlock);
            duplicateBlockBtn.addEventListener('click', duplicateCurrentBlock);
            renameBlockBtn.addEventListener('click', renameCurrentBlock);
            moveLeftBtn.addEventListener('click', moveBlockLeft);
            moveRightBtn.addEventListener('click', moveBlockRight);
            
            // é’¢ç´é”®ç›˜æ§åˆ¶æŒ‰é’®
            octaveDownBtn.addEventListener('click', decreaseOctave);
            octaveUpBtn.addEventListener('click', increaseOctave);
            
            // æ­Œæ›²å¯¼å‡º/å¯¼å…¥æŒ‰é’®
            exportBtn.addEventListener('click', exportSong);
            importFile.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    const file = e.target.files[0];
                    if (file.name.endsWith('.song')) {
                        importSong(file);
                    } else {
                        alert('Please select a .song file');
                    }
                }
                // é‡ç½®æ–‡ä»¶è¾“å…¥
                e.target.value = '';
            });
            
            // é”®ç›˜å¿«æ·é”®
            document.addEventListener('keydown', (e) => {
                // ç©ºæ ¼é”®åˆ‡æ¢æ’­æ”¾/æš‚åœ
                if (e.code === 'Space') {
                    e.preventDefault();
                    if (isPlaying) {
                        pausePlayback(); // æš‚åœæ’­æ”¾ï¼Œä¸é‡ç½®è¿›åº¦
                    } else {
                        startPlayback();
                    }
                }
                
                // Escapeåœæ­¢æ’­æ”¾å¹¶é‡ç½®è¿›åº¦
                if (e.code === 'Escape') {
                    stopPlayback();
                }
                
                // å·¦Ctrlé”®æ§åˆ¶loopæŒ‰é’®
                if (e.code === 'ControlLeft' && !e.repeat) {
                    toggleLoopMode();
                }
                
                // å·¦å³ç®­å¤´é”®å¯¼èˆªblocks
                if (e.code === 'ArrowLeft') {
                    const newBlock = (currentBlock - 1 + blocks.length) % blocks.length;
                    setCurrentBlock(newBlock);
                }
                if (e.code === 'ArrowRight') {
                    const newBlock = (currentBlock + 1) % blocks.length;
                    setCurrentBlock(newBlock);
                }
                
                // Zå’ŒXé”®è°ƒæ•´å…«åº¦
                if (e.code === 'KeyZ') {
                    decreaseOctave();
                }
                if (e.code === 'KeyX') {
                    increaseOctave();
                }
                
                // Qå’ŒWé”®è°ƒæ•´åŠéŸ³
                if (e.code === 'KeyQ') {
                    decreaseSemitone();
                }
                if (e.code === 'KeyW') {
                    increaseSemitone();
                }
                
                // Fé”®åˆ‡æ¢å…¨å±
                if (e.code === 'KeyF') {
                    toggleFullscreen();
                }
                
                // Né”®æ–°å»ºå·¥ç¨‹
                if (e.code === 'KeyN' && (e.ctrlKey || e.metaKey)) {
                    e.preventDefault();
                    newProject();
                }
                
                // Cé”®åˆ‡æ¢å­—å¹•éŸ³åºå™¨
                if (e.code === 'KeyC' && (e.ctrlKey || e.metaKey)) {
                    e.preventDefault();
                    toggleCaptionSequencer();
                }
                
                // Hé”®åˆ‡æ¢å¸®åŠ©çª—å£
                if (e.code === 'KeyH' && (e.ctrlKey || e.metaKey)) {
                    e.preventDefault();
                    toggleHelpWindow();
                }
                
                // æ•°å­—é”®1-7æ§åˆ¶é’¢ç´é”®ç›˜ç™½é”®
                if (e.code >= 'Digit1' && e.code <= 'Digit7') {
                    const index = parseInt(e.code.replace('Digit', '')) - 1;
                    const whiteKeys = document.querySelectorAll('.white-key');
                    if (index < whiteKeys.length) {
                        const key = whiteKeys[index];
                        const midiNote = parseInt(key.dataset.note);
                        selectedNote = midiNote;
                        
                        // æ›´æ–°é”®ç›˜æ˜¾ç¤º
                        document.querySelectorAll('.piano-key').forEach(k => {
                            k.classList.remove('active');
                        });
                        key.classList.add('active');
                        
                        // æ’­æ”¾é¢„è§ˆå£°éŸ³ï¼ˆä½¿ç”¨æ–¹æ³¢ï¼‰
                        playSoundPreview(midiNote);
                    }
                }
            });
        }
        
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>